<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Pro - Gestión de Capital Humano</title>
    <meta name="description" content="Sistema avanzado de gestión de recursos humanos y registro de empleados.">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            /* Palette - Institutional Toluca */
            --primary: #811231;
            --primary-hover: #b59b6b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent: #b59b6b;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        [data-theme="sepia"] {
            --primary: #8d6e63;
            --primary-hover: #795548;
            --bg-main: #f1e7d0;
            --bg-card: #fbf6e9;
            --text-main: #433422;
            --text-muted: #7c6f5d;
            --accent: #a1887f;
            --border: #ded3bd;
            --shadow: 0 10px 15px -3px rgba(67, 52, 34, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            transition: var(--transition);
        }

        /* Sidebar Styles */
        nav {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: var(--transition);
        }

        /* Responsive Sidebar */
        @media (max-width: 1024px) {
            nav {
                transform: translateX(-100%);
                width: 280px;
            }

            nav.active {
                transform: translateX(0);
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
            }

            main {
                margin-left: 0 !important;
                padding: 1rem !important;
            }

            .mobile-toggle {
                display: flex !important;
            }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1.25rem;
            z-index: 1100;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: var(--shadow);
            align-items: center;
            justify-content: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .menu {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .menu-item {
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .menu-item:hover,
        .menu-item.active {
            background: rgba(129, 18, 49, 0.1);
            color: var(--primary);
        }

        .menu-item svg {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        main {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-width: 0;
            transition: var(--transition);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-title p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        /* Dropdown Theme Container */
        .theme-dropdown {
            position: relative;
            display: inline-block;
            margin-right: 0.5rem;
            z-index: 200;
            /* Ensure it's on top */
        }

        /* The Button is the Anchor */
        .theme-toggle {
            position: relative;
            z-index: 210;
            /* Above the fan items */
            background: var(--bg-card);
            /* Ensure opaque bg if needed */
        }

        /* Fan Container (Invisible Hover Zone) */
        .theme-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            /* Expand capture area */
            height: 200px;
            transform: translate(-50%, -50%);
            /* Centered on button */
            z-index: 200;
            display: block;
            pointer-events: none;
            /* Default: click-through */
        }

        /* Liquid Crystal Bubbles (Options) */
        .theme-option {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;

            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);

            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Bouncy pop */
            padding: 0;
            /* Icon only for cleaner fan */
            overflow: hidden;
        }

        /* Dark Mode Glass */
        [data-theme="dark"] .theme-option {
            background: rgba(30, 41, 59, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        [data-theme="sepia"] .theme-option {
            background: rgba(251, 246, 233, 0.85);
            border: 1px solid rgba(222, 211, 189, 0.8);
        }

        /* Hover Interaction */
        .theme-dropdown:hover .theme-menu,
        .theme-menu:hover {
            pointer-events: auto;
        }

        /* Fan Deployment Positions */
        /* Item 1: Left */
        .theme-dropdown:hover .theme-menu .theme-option:nth-child(1) {
            opacity: 1;
            transform: translate(-65px, -20px) scale(1);
        }

        /* Item 2: Diagonal */
        .theme-dropdown:hover .theme-menu .theme-option:nth-child(2) {
            opacity: 1;
            transform: translate(-45px, 40px) scale(1);
        }

        /* Item 3: Down */
        .theme-dropdown:hover .theme-menu .theme-option:nth-child(3) {
            opacity: 1;
            transform: translate(15px, 50px) scale(1);
        }

        /* Hover on individual items - Maintain position & Scale up */
        .theme-option:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            z-index: 220;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }

        /* Specific Hover Transforms to keep them in place */
        .theme-dropdown:hover .theme-menu .theme-option:nth-child(1):hover {
            transform: translate(-65px, -20px) scale(1.15);
        }

        .theme-dropdown:hover .theme-menu .theme-option:nth-child(2):hover {
            transform: translate(-45px, 40px) scale(1.15);
        }

        .theme-dropdown:hover .theme-menu .theme-option:nth-child(3):hover {
            transform: translate(15px, 50px) scale(1.15);
        }

        /* Icon sizing within bubbles */
        .theme-option svg {
            width: 20px;
            height: 20px;
        }



        /* Fan stagger effect via transition delay */
        .theme-option:nth-child(1) {
            transition-delay: 0.0s;
        }

        .theme-option:nth-child(2) {
            transition-delay: 0.05s;
        }

        .theme-option:nth-child(3) {
            transition-delay: 0.1s;
        }

        /* Card / Form / Tables */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        /* Form Grid Responsive */
        .grid-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        /* Responsive Table Container */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--radius);
        }

        table {
            width: 100%;
            min-width: 900px;
            /* Ensure table data doesn't squash on mobile */
            border-collapse: collapse;
        }

        @media (max-width: 1024px) {
            nav {
                transform: translateX(-100%);
            }

            nav.active {
                transform: translateX(0);
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
            }

            main {
                margin-left: 0 !important;
                padding: 1.5rem !important;
            }

            .mobile-toggle {
                display: flex !important;
            }

            header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 1rem;
                margin-top: 2rem;
            }

            .actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        @media (max-width: 640px) {
            h1 {
                font-size: 1.5rem !important;
            }

            .header-title p {
                font-size: 0.85rem !important;
            }

            .card {
                padding: 1.5rem !important;
            }
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .btn {
            padding: 0.75rem 2rem;
            border-radius: var(--radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .btn-ghost:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
        }

        /* Modal / Edit Overlay */
        .edit-mode {
            border: 2px solid var(--primary) !important;
            position: relative;
        }

        .edit-mode::before {
            content: "Editando";
            position: absolute;
            top: -12px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Settings Tabs CSS */
        .settings-tab {
            padding: 0.8rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
        }

        .settings-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .settings-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .settings-content.active {
            display: block;
        }

        .holiday-tag {
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .holiday-tag button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        td {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }

        tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-info {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
        }

        .toast.success {
            border-left-color: #22c55e;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading States */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin: -10px 0 0 -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-success-active {
            background-color: #22c55e !important;
            border-color: #22c55e !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
            transition: var(--transition);
        }

        /* ChatBot CSS */
        .chatbot-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(129, 18, 49, 0.3);
            z-index: 999;
            transition: var(--transition);
        }

        .chatbot-toggle:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .chat-window {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 380px;
            height: 500px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: rgba(0, 0, 0, 0.02);
        }

        .message {
            max-width: 85%;
            padding: 0.9rem 1.25rem;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .message.bot {
            background: white;
            color: var(--text-main);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--primary);
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary), #a21a3e);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px rgba(129, 18, 49, 0.2);
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-area input {
            flex: 1;
            border: 1px solid var(--border);
            padding: 0.8rem;
            border-radius: 10px;
            outline: none;
            font-size: 0.9rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .month-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .month-header {
            text-align: center;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1rem;
            background: var(--bg-main);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: default;
            transition: var(--transition);
            position: relative;
        }

        .day-cell.empty {
            cursor: default;
        }

        .day-cell:not(.empty):hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .day-cell.holiday {
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 5px,
                    rgba(100, 116, 139, 0.1) 5px,
                    rgba(100, 116, 139, 0.1) 10px);
            border: 1px solid var(--border);
            font-weight: 700;
        }

        .day-cell.vacation {
            background-color: #64748b !important;
            color: white !important;
            font-weight: 600;
        }

        /* Indicadores de Dashboard en Calendario */
        .attendance-dots {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        .dot.present {
            background: #22c55e;
        }

        .dot.late {
            background: #eab308;
        }

        .dot.absent {
            background: #ef4444;
        }

        .day-cell.has-data {
            border: 1px solid rgba(129, 18, 49, 0.1);
            cursor: pointer;
        }

        .day-cell .tooltip {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: 0.2s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            text-align: left;
        }

        .day-cell:hover .tooltip {
            opacity: 1;
            visibility: visible;
            bottom: 120%;
        }

        .calendar-legend {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .legend-box.vacation {
            background-color: #64748b;
        }

        .legend-box.holiday {
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 3px,
                    rgba(100, 116, 139, 0.2) 3px,
                    rgba(100, 116, 139, 0.2) 6px);
            border: 1px solid #94a3b8;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: all 0.3s ease;
        }

        .modal-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 90%;
            max-width: 420px;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-overlay.active .modal-card {
            transform: scale(1);
            opacity: 1;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modal-text {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 2.5rem;
            font-size: 1rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Media Query eliminado por redundancia y conflicto con el sistema de sidebar colapsable */

        /* --- Login Overlay --- */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-main);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-card {
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 100%;
            max-width: 420px;
            border: 1px solid var(--border);
            animation: fadeIn 0.8s ease-out;
        }

        .login-logo {
            font-size: 3rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .login-input {
            width: 100%;
            padding: 1.25rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            text-align: center;
            background: var(--bg-main);
            color: var(--text-main);
            transition: var(--transition);
        }

        .login-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(129, 18, 49, 0.1);
        }

        @media (max-width: 480px) {
            .login-card {
                padding: 2rem 1.5rem;
            }

            .login-logo {
                font-size: 2.2rem;
            }

            .login-input {
                font-size: 1.2rem;
                padding: 1rem;
            }
        }
    </style>
</head>

<body data-theme="light">
    <!-- Login Screen (Visible por defecto por seguridad) -->
    <div id="loginOverlay" style="display: flex; background: var(--bg-main); transition: opacity 0.5s ease;">
        <div class="login-card">
            <div class="login-logo">SIRECOA</div>
            <h2 style="margin-bottom: 0.5rem; font-weight: 700;">Panel de Control</h2>
            <p style="color: var(--text-muted); margin-bottom: 2.5rem; font-size: 1.1rem;">Por favor, ingresa tu
                LulaPass</p>
            <input type="password" id="loginPass" class="login-input" placeholder="••••••••"
                onkeypress="if(event.key==='Enter') window.checkPassword()">
            <button class="btn btn-primary" style="width: 100%; padding: 1.25rem; font-size: 1.2rem; font-weight: 600;"
                onclick="window.checkPassword()">Acceder al Sistema</button>
            <p id="loginError"
                style="color: #ef4444; margin-top: 1.5rem; font-weight: 600; font-size: 0.95rem; display: none;">❌
                Contraseña incorrecta. Intenta de nuevo.</p>
        </div>
    </div>

    <button class="mobile-toggle" id="mobile-toggle-btn" onclick="window.toggleSidebar()" style="display: none;">
        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <nav>
        <div class="logo-container"
            style="text-align: center; margin-bottom: -1rem; background: #ffffff; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <img src="Toluca-logo.png" alt="Logo Toluca"
                style="width: 100%; max-width: 320px; height: auto; object-fit: contain;">
        </div>
        <ul class="menu" style="margin-top: 2rem;">
            <li class="menu-item active" id="menu-home">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Inicio</span>
            </li>
            <li class="menu-item" id="menu-employees">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
                <span>Directorio</span>
            </li>
            <li class="menu-item" id="menu-attendance">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
                <span>Asistencia</span>
            </li>
            <li class="menu-item" id="menu-reports">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M12 20h9" />
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                </svg>
                <span>Reportes</span>
            </li>
            <li class="menu-item" id="menu-calendar">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
                <span>Calendario</span>
            </li>
            <li class="menu-item" id="menu-seniority">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="M12 8v4"></path>
                    <path d="M12 16h.01"></path>
                </svg>
                <span>Antigüedad</span>
            </li>
            <li class="menu-item" id="menu-settings">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                </svg>
                <span>Ajustes</span>
            </li>
            <li class="menu-item" id="menu-bajas"
                style="margin-top: auto; border-top: 1px solid var(--border); padding-top: 1rem;">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="#ef4444" stroke-width="2" fill="none">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <line x1="23" y1="11" x2="17" y2="11" />
                </svg>
                <span style="color: #ef4444;">Bajas Registradas</span>
            </li>
        </ul>
    </nav>

    <main>
        <header>
            <div class="header-title">
                <h1 class="logo"
                    style="font-size: 2rem; margin-bottom: 0.2rem; background: linear-gradient(135deg, #811231, #b59b6b); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                    Registro y Control de Asistencia</h1>
                <p style="font-size: 1.1rem; font-weight: 500;" id="welcomeMessage">Lulabel, bienvenida al panel de
                    control.</p>
            </div>
            <div class="actions">
                <div class="theme-dropdown">
                    <button class="theme-toggle" id="themeBtn" title="Cambiar Tema">
                        <svg id="themeIcon" viewBox="0 0 24 24" width="20" height="20" stroke="currentColor"
                            stroke-width="2" fill="none">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                        </svg>
                    </button>
                    <div class="theme-menu">
                        <button class="theme-option" onclick="window.setTheme('light')" title="Claro">
                            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2"
                                fill="none">
                                <circle cx="12" cy="12" r="5" />
                                <line x1="12" y1="1" x2="12" y2="3" />
                                <line x1="12" y1="21" x2="12" y2="23" />
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                                <line x1="1" y1="12" x2="3" y2="12" />
                                <line x1="21" y1="12" x2="23" y2="12" />
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                            </svg>
                        </button>
                        <button class="theme-option" onclick="window.setTheme('dark')" title="Oscuro">
                            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2"
                                fill="none">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                            </svg>
                        </button>
                        <button class="theme-option" onclick="window.setTheme('sepia')" title="Sepia">
                            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2"
                                fill="none">
                                <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                                <line x1="6" y1="1" x2="6" y2="4"></line>
                                <line x1="10" y1="1" x2="10" y2="4"></line>
                                <line x1="14" y1="1" x2="14" y2="4"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div
                    style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                    L</div>
            </div>
        </header>

        <!-- Home / Welcome Screen -->
        <section id="homeSection" class="card"
            style="display: flex; animation: fadeIn 0.6s ease-out; min-height: calc(100vh - 12rem); flex-direction: column; align-items: center; justify-content: center; text-align: center; background: linear-gradient(to bottom, var(--bg-card), rgba(129, 18, 49, 0.03));">
            <div style="margin-bottom: 2rem; width: 100%; max-width: 450px;">
                <img src="Toluca-logo.png" alt="Logo Toluca" style="width: 100%; height: auto; object-fit: contain;">
            </div>
            <h1 style="font-size: 2.5rem; color: #811231; margin-bottom: 1rem; font-weight: 700;">Sistema de Registro y
                Control de Asistencia</h1>
            <p style="font-size: 1.25rem; color: var(--text-muted); max-width: 600px; margin-bottom: 3rem;">Dirección
                General de Medio Ambiente del Municipio de Toluca.</p>

            <div style="width: 100%; max-width: 800px; border-radius: 24px; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.15); border: 4px solid var(--bg-card); transform: translateY(0); transition: var(--transition); background: #eee;"
                onmouseover="this.style.transform='translateY(-10px)'"
                onmouseout="this.style.transform='translateY(0)'">
                <img src="environment_office.png" alt="Oficinas Sustentables - Dirección General de Medio Ambiente"
                    style="width: 100%; height: 450px; object-fit: cover; display: block;">
            </div>
        </section>

        <!-- Directorio Table -->
        <section id="directorySection" class="card" style="display: none;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                <h2 style="font-size: 1.25rem;">Directorio de Empleados</h2>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn btn-primary" id="toggleFormBtn" onclick="window.toggleRegisterForm()">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                            fill="none">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Nuevo Empleado
                    </button>
                    <input type="text" id="search" placeholder="Buscar empleado..."
                        style="width: 200px; margin-bottom: 0;">

                    <input type="file" id="csvImport" accept=".csv" style="display: none;">
                    <button class="btn btn-ghost" onclick="document.getElementById('csvImport').click()"
                        title="Importar CSV">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                            fill="none">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                    </button>

                    <button class="btn btn-ghost" onclick="window.exportCSV()" title="Exportar CSV">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                            fill="none">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                    </button>

                    <button class="btn btn-ghost" onclick="window.clearEmployees()" title="Limpiar Todo"
                        style="color: #ef4444;">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                            fill="none">
                            <path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                            <line x1="10" y1="11" x2="10" y2="17" />
                            <line x1="14" y1="11" x2="14" y2="17" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Registro Form (Embedded) -->
            <div id="registrationContainer"
                style="display: none; border: 1px dashed var(--primary); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; background: rgba(129, 18, 49, 0.02); animation: slideDown 0.4s ease-out;">
                <h3 id="formTitle" style="margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--primary);">Registro de
                    Nuevo Empleado</h3>
                <form id="employeeForm">
                    <div class="grid-form">
                        <div class="form-group">
                            <label for="clave">Clave</label>
                            <input type="text" id="clave" placeholder="Ej. EMP-001" required>
                        </div>
                        <div class="form-group">
                            <label for="nombre">Nombre de Empleado</label>
                            <input type="text" id="nombre" placeholder="Nombre completo" required>
                        </div>
                        <div class="form-group">
                            <label for="tipo">Tipo</label>
                            <select id="tipo" required>
                                <option value="" disabled selected>Seleccionar...</option>
                                <option value="Funcionario">Funcionario</option>
                                <option value="Generales">Generales</option>
                                <option value="Sindicalizado">Sindicalizado</option>
                                <option value="Confianza">Confianza</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="direccion">Dirección</label>
                            <select id="direccion" required>
                                <option value="" disabled selected>Cargando catálogo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="departamento">Departamento</label>
                            <select id="departamento" required>
                                <option value="" disabled selected>Cargando catálogo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="comision">Comisión</label>
                            <select id="comision">
                                <option value="" disabled selected>Cargando catálogo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fechaAlta">Fecha Alta Original</label>
                            <input type="date" id="fechaAlta">
                        </div>
                        <div class="form-group">
                            <label for="fechaAntiguedad">Fecha Antigüedad</label>
                            <input type="date" id="fechaAntiguedad">
                        </div>
                    </div>

                    <div class="switch-group">
                        <label class="switch">
                            <input type="checkbox" id="comisionado">
                            <span class="slider"></span>
                        </label>
                        <span style="font-weight: 500; font-size: 0.9rem;">Comisionado</span>
                    </div>

                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" id="cancelBtn" onclick="window.toggleRegisterForm()"
                            style="background: var(--bg-main); border: 1px solid var(--border); margin-right: 0.5rem;">Cerrar</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span id="btnText">Registrar Empleado</span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="table-container">
                <table id="employeeTable">
                    <thead>
                        <tr>
                            <th>Clave</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Dirección</th>
                            <th>Departamento</th>
                            <th>Comisión</th>
                            <th>Alta Original</th>
                            <th>Antigüedad</th>
                            <th>Estatus</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Calendario Section -->
        <section id="calendarSection" class="calendar-section" style="display: none;">
            <div class="card" style="margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Calendario Oficial 2026</h2>
                <p style="color: var(--text-muted);">Días no laborables y periodos vacacionales autorizados.</p>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Months generate here -->
            </div>

            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-box holiday"></div>
                    <span>Días no laborables</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box vacation"></div>
                    <span>Vacaciones</span>
                </div>
                <!-- Dashboard legend -->
                <div class="legend-item">
                    <div class="dot present" style="width:10px; height:10px; border-radius:50%;"></div>
                    <span>Asistencias</span>
                </div>
                <div class="legend-item">
                    <div class="dot late" style="width:10px; height:10px; border-radius:50%;"></div>
                    <span>Retardos</span>
                </div>
                <div class="legend-item">
                    <div class="dot absent" style="width:10px; height:10px; border-radius:50%;"></div>
                    <span>Faltas</span>
                </div>
                <div class="legend-item" style="margin-left: auto; color: var(--text-muted); font-style: italic;">
                    * Basado en el calendario oficial y registros de SIRECOA 2026
                </div>
            </div>
        </section>

        <!-- Attendance Section -->
        <section id="attendanceSection" class="card" style="display: none; animation: fadeIn 0.5s ease-out;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Control de Asistencia Diaria</h2>
                    <p style="color: var(--text-muted);">Registra la puntualidad del personal.</p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="attendanceSearch" placeholder="Buscar por nombre..."
                        style="margin-bottom: 0; min-width: 250px;">
                    <input type="date" id="attendanceDate" style="margin-bottom: 0;">
                    <button class="btn btn-primary" onclick="window.saveAttendance()">Guardar Todo</button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Departamento</th>
                            <th style="text-align: center;">Estatus de Asistencia</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <!-- Employees for attendance will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reportsSection" class="card" style="display: none; animation: fadeIn 0.5s ease-out;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Reportes Mensuales</h2>
                    <p style="color: var(--text-muted);">Resumen detallado de asistencia por periodo.</p>
                </div>
                <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                    <select id="reportType" style="margin-bottom: 0; min-width: 180px;"
                        onchange="window.updateReportFilters()">
                        <option value="monthly">Resumen Mensual</option>
                        <option value="employee">Por Empleado</option>
                        <option value="concept">Por Concepto</option>
                    </select>

                    <div id="filterEmployee" style="display: none;">
                        <select id="reportEmployeeSelect" style="margin-bottom: 0; min-width: 200px;">
                            <!-- Employees will be loaded here -->
                        </select>
                    </div>

                    <div id="filterConcept" style="display: none;">
                        <select id="reportConceptSelect" style="margin-bottom: 0; min-width: 180px;">
                            <!-- Concepts will be loaded here -->
                        </select>
                    </div>

                    <select id="reportMonth" style="margin-bottom: 0; min-width: 110px;">
                        <option value="0">Enero</option>
                        <option value="1">Febrero</option>
                        <option value="2">Marzo</option>
                        <option value="3">Abril</option>
                        <option value="4">Mayo</option>
                        <option value="5">Junio</option>
                        <option value="6">Julio</option>
                        <option value="7">Agosto</option>
                        <option value="8">Septiembre</option>
                        <option value="9">Octubre</option>
                        <option value="10">Noviembre</option>
                        <option value="11">Diciembre</option>
                    </select>
                    <select id="reportYear" style="margin-bottom: 0; min-width: 90px;">
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                    </select>
                    <button class="btn btn-primary" onclick="window.generateReport()">Generar</button>
                    <button class="btn" style="background: #1e293b; color: white;" onclick="window.previewPDF()">Vista
                        Previa PDF</button>
                </div>
            </div>

            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                <table id="reportsTable" style="font-size: 0.8rem;">
                    <thead id="reportsThead">
                        <!-- Dynamic Headers -->
                    </thead>
                    <tbody id="reportsTbody">
                        <!-- Report data -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Seniority (Antigüedad) Section -->
        <section id="senioritySection" class="card" style="display: none; animation: fadeIn 0.5s ease-out;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Cálculo de Antigüedad</h2>
                    <p style="color: var(--text-muted);">Años, meses y días de servicio acumulados.</p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="text" id="senioritySearch" placeholder="Buscar empleado..."
                        style="width: 250px; margin-bottom: 0;">
                    <button class="btn" style="background: #1e293b; color: white;"
                        onclick="window.previewSeniorityPDF()">Vista Previa Reporte</button>
                </div>
            </div>

            <!-- Tabulador Manual -->
            <div id="manualSeniorityTab"
                style="background: rgba(129, 18, 49, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px dashed var(--primary); animation: fadeIn 0.4s ease-out;">
                <h3
                    style="font-size: 1rem; margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    Tabulador Manual de Antigüedad
                </h3>
                <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Ingresar Fecha de Alta</label>
                        <input type="date" id="manualDateInput" style="margin-bottom: 0; border-color: var(--primary);">
                    </div>
                    <button class="btn btn-primary" onclick="window.runManualCalculation()">Calcular Antigüedad</button>
                    <div id="manualResult"
                        style="padding: 0.7rem 1.5rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--primary); font-weight: 700; color: var(--primary); min-width: 250px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
                        Resultado aparecerá aquí
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="seniorityTable" style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th rowspan="2">Empleado</th>
                            <th colspan="2" style="text-align: center;">Alta Original</th>
                            <th colspan="2" style="text-align: center;">Actualización de Alta</th>
                        </tr>
                        <tr>
                            <th style="text-align: center; border-left: 1px solid var(--border);">Fecha</th>
                            <th style="text-align: center;">Antigüedad Acumulada</th>
                            <th style="text-align: center; border-left: 1px solid var(--border);">Fecha</th>
                            <th style="text-align: center;">Antigüedad Acumulada</th>
                        </tr>
                    </thead>
                    <tbody id="seniorityTbody">
                        <!-- Seniority data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Configuration (Ajustes) Section -->
        <section id="settingsSection" class="card" style="display: none; animation: fadeIn 0.5s ease-out;">
            <div style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Panel de Ajustes</h2>
                <p style="color: var(--text-muted);">Personaliza y configura el comportamiento global del sistema.</p>
            </div>

            <!-- Settings Tabs Header -->
            <div
                style="display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); overflow-x: auto; padding-bottom: 5px;">
                <button class="settings-tab active"
                    onclick="window.switchSettingsTab('institutional')">Institucional</button>
                <button class="settings-tab" onclick="window.switchSettingsTab('catalogs')">Catálogos</button>
                <button class="settings-tab" onclick="window.switchSettingsTab('rules')">Reglas</button>
                <button class="settings-tab" onclick="window.switchSettingsTab('backup')">Seguridad</button>
                <button class="settings-tab" onclick="window.switchSettingsTab('profile')">Perfil</button>
            </div>

            <!-- Tab: Institutional -->
            <div id="tab-institutional" class="settings-content active">
                <div class="grid-form">
                    <div class="form-group">
                        <label>Nombre de la Institución</label>
                        <input type="text" id="set-inst-name" placeholder="Municipio de Toluca">
                    </div>
                    <div class="form-group">
                        <label>Logo (URL o Base64)</label>
                        <input type="text" id="set-inst-logo" placeholder="URL del logo...">
                    </div>
                </div>
                <h3 style="font-size: 1rem; margin: 1.5rem 0 1rem; color: var(--primary);">Firmas en Reportes PDF</h3>
                <div class="grid-form">
                    <div class="form-group">
                        <label>Elaboró (Nombre)</label>
                        <input type="text" id="set-sign-name1">
                    </div>
                    <div class="form-group">
                        <label>Elaboró (Cargo)</label>
                        <input type="text" id="set-sign-cargo1">
                    </div>
                    <div class="form-group">
                        <label>Autorizó (Nombre)</label>
                        <input type="text" id="set-sign-name2">
                    </div>
                    <div class="form-group">
                        <label>Autorizó (Cargo)</label>
                        <input type="text" id="set-sign-cargo2">
                    </div>
                </div>
            </div>

            <!-- Tab: Catalogs -->
            <div id="tab-catalogs" class="settings-content">
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem;">Edita las opciones
                    separándolas por comas (Ej: Jurídica, Administración, Servicios).</p>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Catálogo de Direcciones</label>
                    <textarea id="set-cat-direcciones" style="width: 100%; height: 80px;"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Catálogo de Departamentos</label>
                    <textarea id="set-cat-departamentos" style="width: 100%; height: 80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Catálogo de Comisiones</label>
                    <textarea id="set-cat-comisiones" style="width: 100%; height: 80px;"></textarea>
                </div>
            </div>

            <!-- Tab: Rules -->
            <div id="tab-rules" class="settings-content">
                <div class="grid-form">
                    <div class="form-group">
                        <label>Tolerancia de Entrada (minutos)</label>
                        <input type="number" id="set-rule-tolerance" value="15">
                    </div>
                </div>
                <h3 style="font-size: 1rem; margin: 1.5rem 0 1rem; color: var(--primary);">Gestor de Días Inhábiles</h3>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="date" id="new-holiday-date" style="margin-bottom: 0;">
                    <button class="btn btn-primary" onclick="window.addHoliday()">Agregar</button>
                </div>
                <div id="holidays-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <!-- Holiday tags will appear here -->
                </div>
            </div>

            <!-- Tab: Backup/Security -->
            <div id="tab-backup" class="settings-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                    <div
                        style="padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(0,0,0,0.01);">
                        <h4 style="margin-bottom: 0.5rem;">Password de Acceso</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Protege el acceso a
                            la aplicación con una contraseña maestra.</p>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <input type="password" id="set-app-password" placeholder="Sin contraseña (público)">
                        </div>
                        <p style="font-size: 0.7rem; color: var(--primary); font-style: italic;">Deja en blanco para
                            entrar sin clave.</p>
                    </div>
                </div>

                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                    <div
                        style="padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(0,0,0,0.01);">
                        <h4 style="margin-bottom: 0.5rem;">Cerebro AI (Gemini)</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Activa el asistente
                            inteligente LulaBot para analizar tus datos.</p>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <input type="password" id="set-gemini-key" placeholder="Pega tu API Key de Google aquí">
                        </div>
                        <p style="font-size: 0.65rem; color: var(--text-muted);">Obtén una gratis en <a
                                href="https://aistudio.google.com/app/apikey" target="_blank"
                                style="color:var(--primary)">Google AI Studio</a>.</p>
                    </div>

                    <div
                        style="padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(0,0,0,0.01);">
                        <h4 style="margin-bottom: 0.5rem;">Exportar Datos</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Descarga un
                            respaldo completo en formato JSON de todos tus empleados y asistencias.</p>
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;"
                            onclick="window.exportFullBackup()">Descargar Respaldo JSON</button>
                        <button class="btn btn-secondary"
                            style="width: 100%; background: transparent; border: 1px solid var(--primary); color: var(--primary);"
                            onclick="window.sendEmailBackup()">Enviar Respaldo a mi Correo</button>
                    </div>
                    <div
                        style="padding: 1.5rem; border: 1px solid #ef4444; border-radius: 12px; background: rgba(239, 68, 68, 0.05);">
                        <h4 style="margin-bottom: 0.5rem; color: #ef4444;">Zona de Peligro</h4>
                        <p style="font-size: 0.8rem; color: #ef4444; margin-bottom: 1rem;">Borra todos los registros del
                            sistema. Esta acción es irreversible.</p>
                        <button class="btn" style="width: 100%; background: #ef4444; color: white;"
                            onclick="window.resetSystemData()">Reiniciar Sistema</button>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="settings-content">
                <div class="grid-form">
                    <div class="form-group">
                        <label>Nombre de Usuario (Saludo)</label>
                        <input type="text" id="set-user-name" placeholder="Lulabel">
                    </div>
                    <div class="form-group">
                        <label>Correo Electrónico para Respaldos</label>
                        <input type="email" id="set-user-email" placeholder="ejemplo@correo.com">
                        <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.3rem;">Aquí se enviarán los
                            avisos de sincronización y respaldos automáticos.</p>
                    </div>
                </div>
                <!-- Auth Actions -->
                <div style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                    <button class="btn btn-secondary" onclick="window.logoutSystem()"
                        style="color: var(--primary); border-color: var(--primary); background: transparent;">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2"
                            fill="none" style="margin-right: 8px; vertical-align: middle;">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />
                        </svg>
                        Cerrar Sesión / Bloquear
                    </button>
                </div>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border); text-align: right;">
                <button class="btn btn-primary" id="saveSettingsBtn" onclick="window.saveAllSettings(this)">Guardar
                    Todos los Ajustes</button>
            </div>
        </section>

        <!-- Bajas Section -->
        <section id="bajasSection" style="display: none;">
            <div class="header-table">
                <div>
                    <h2 style="font-size: 1.5rem; color: var(--primary); margin-bottom: 0.5rem;">Registro de Bajas</h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Personal que ha sido dado de baja o removido
                        del directorio activo.</p>
                </div>
                <div class="actions">
                    <input type="text" id="bajasSearch" placeholder="Buscar en bajas..."
                        style="width: 250px; margin-bottom: 0;" oninput="window.renderBajas()">
                </div>
            </div>

            <div class="card" style="margin-top: 2rem; overflow: hidden;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Clave</th>
                                <th>Nombre</th>
                                <th>Departamento</th>
                                <th>Fecha de Baja</th>
                                <th style="text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bajasTbody">
                            <!-- Bajas will appear here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="#ef4444" stroke-width="2" fill="none">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Confirmar Eliminación
            </div>
            <p class="modal-text">¿Estás seguro de que deseas eliminar permanentemente este registro? Esta acción no se
                puede deshacer.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="window.closeDeleteModal()"
                    style="background: transparent; color: var(--text-muted); border: 1px solid var(--border);">Cancelar</button>
                <button class="btn" onclick="window.confirmDelete()" style="background: #ef4444; color: white;">Eliminar
                    ahora</button>
            </div>
        </div>
    </div>



    <!-- Report Preview Modal -->
    <div id="previewModal" class="modal-overlay">
        <div class="modal-card" style="max-width: 1100px; width: 95%;">
            <div class="modal-title">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Vista Previa de Reporte
            </div>
            <div id="pdfContent"
                style="padding: 2rem; background: white; color: black; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #ddd; max-height: 50vh; overflow-y: auto;">
                <!-- The report content will be cloned here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="window.closePreviewModal()"
                    style="background: transparent; color: var(--text-muted); border: 1px solid var(--border);">Cerrar</button>
                <button class="btn btn-primary" onclick="window.exportToPDF()">Descargar PDF</button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Core Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyCo_t2pFMtZq5_CgL2i1geFZQSfmYVK2j4",
            authDomain: "sirecoa-pro.firebaseapp.com",
            projectId: "sirecoa-pro",
            storageBucket: "sirecoa-pro.firebasestorage.app",
            messagingSenderId: "806841040491",
            appId: "1:806841040491:web:de946568679a34d698bb2e",
            measurementId: "G-6TBNH2ZYS0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Optimización para redes restringidas o firewalls
        try {
            db.settings({ experimentalForceLongPolling: true });
        } catch (e) { console.warn("Error en settings:", e); }

        // Habilitar persistencia local
        try {
            db.enablePersistence({ synchronizeTabs: false }).catch(err => {
                console.warn("Persistencia no habilitada:", err.code);
            });
        } catch (e) { }

        // Global State
        let employees = JSON.parse(localStorage.getItem('hr_employees')) || [];
        let bajas = JSON.parse(localStorage.getItem('hr_bajas')) || [];
        let attendanceRecord = JSON.parse(localStorage.getItem('hr_attendance')) || {};
        let editingId = null;

        // --- Responsive & UI Helpers ---
        window.toggleSidebar = () => {
            const nav = document.querySelector('nav');
            nav.classList.toggle('active');
        };

        // Cerrar sidebar al hacer click fuera o en un item (móvil)
        document.addEventListener('click', (e) => {
            const nav = document.querySelector('nav');
            const btn = document.getElementById('mobile-toggle-btn');
            if (nav.classList.contains('active')) {
                if (!nav.contains(e.target) && !btn.contains(e.target)) {
                    nav.classList.remove('active');
                }
            }
        });

        // Asegurar que el menú se cierre al seleccionar una opción en móvil
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        document.querySelector('nav').classList.remove('active');
                    }
                });
            });
        });

        // Cloud Synchronization Helpers
        async function pushDataToCloud() {
            const sanitize = (obj) => JSON.parse(JSON.stringify(obj || {}));

            console.log("Iniciando sincronización...");

            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error("La nube no responde (Timeout 20s). Revisa si tienes firewall o bloqueos en tu red.")), 20000)
            );

            const pushPromise = (async () => {
                try {
                    // 1. Guardar Master Data
                    console.log("Subiendo empleados y bajas...");
                    await db.collection('sirecoa_data').doc('master').set(sanitize({
                        employees,
                        bajas,
                        lastUpdate: new Date().toISOString()
                    }));

                    // 2. Guardar Settings
                    console.log("Subiendo ajustes...");
                    await db.collection('sirecoa_data').doc('settings').set(sanitize(hrSettings));

                    // 3. Guardar Asistencia (opcional)
                    const currentDate = document.getElementById('attendanceDate')?.value;
                    if (currentDate && attendanceRecord[currentDate]) {
                        console.log("Subiendo asistencia del día...");
                        await db.collection('sirecoa_attendance').doc(currentDate).set(sanitize({
                            records: attendanceRecord[currentDate]
                        }));
                    }
                    console.log('Sincronización completa y exitosa.');
                } catch (e) {
                    console.error("Error interno en pushPromise:", e);
                    throw e;
                }
            })();

            try {
                await Promise.race([pushPromise, timeoutPromise]);
            } catch (error) {
                console.error('Fallo de sincronización:', error);
                let msg = error.message;
                if (msg.includes("permission-denied")) msg = "Error: Reglas de seguridad de Firebase expiradas (Acceso Denegado).";
                if (msg.includes("unavailable")) msg = "Servicio de Google no disponible temporalmente.";
                throw new Error(msg);
            }
        }

        // Función para renderizar todo localmente (sin subir a la nube)
        function renderAll() {
            const searchVal = document.getElementById('search')?.value || '';
            renderTable(searchVal);
            renderBajas();
            renderSeniority();
            renderAttendance();
            loadSettingsToForm();
        }

        async function pullDataFromCloud() {
            try {
                // Intentar solo si hay red y no estamos bloqueados
                const masterDoc = await db.collection('sirecoa_data').doc('master').get();
                if (masterDoc.exists) {
                    const data = masterDoc.data();
                    employees = data.employees || [];
                    bajas = data.bajas || [];
                    localStorage.setItem('hr_employees', JSON.stringify(employees));
                    localStorage.setItem('hr_bajas', JSON.stringify(bajas));
                }

                const settingsDoc = await db.collection('sirecoa_data').doc('settings').get();
                if (settingsDoc.exists) {
                    const cloudSettings = settingsDoc.data();
                    // IMPORTANTE: Protegemos los datos sensibles locales contra versiones vacías de la nube
                    if (!cloudSettings.appPassword && hrSettings.appPassword) {
                        cloudSettings.appPassword = hrSettings.appPassword;
                    }
                    if (!cloudSettings.geminiApiKey && hrSettings.geminiApiKey) {
                        cloudSettings.geminiApiKey = hrSettings.geminiApiKey;
                    }

                    hrSettings = { ...defaultSettings, ...cloudSettings };
                    localStorage.setItem('hr_settings', JSON.stringify(hrSettings));
                    loadSettingsToForm();
                }

                renderAll();
                validateAccess();
            } catch (error) {
                console.error('Error al descargar de la nube:', error.message);
                // Si falla la nube, al menos renderizamos lo que hay en local
                renderAll();
                validateAccess();
            }
        }

        // Auto-load from cloud on startup
        window.addEventListener('load', pullDataFromCloud);

        // ... theme logic ... (modified)
        const themeBtn = document.getElementById('themeBtn');
        const body = document.body;
        const themeIcon = document.getElementById('themeIcon');

        window.setTheme = function (theme) {
            body.setAttribute('data-theme', theme);
            localStorage.setItem('hr_theme', theme);
            updateThemeIcon(theme);
        }

        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                // Moon
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />';
            } else if (theme === 'sepia') {
                // Coffee / Warm
                themeIcon.innerHTML = '<path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line>';
            } else {
                // Sun (Default Light)
                themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
            }
        }

        // Init theme
        const savedTheme = localStorage.getItem('hr_theme') || 'light';
        body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // Navigation Logic
        const navItems = document.querySelectorAll('.menu-item');

        // Helper to hide all main sections
        function hideAllSections() {
            document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
            navItems.forEach(item => item.classList.remove('active'));
        }

        const sectionsMap = {
            'menu-home': 'homeSection',
            'menu-employees': 'directorySection',
            'menu-attendance': 'attendanceSection',
            'menu-reports': 'reportsSection',
            'menu-calendar': 'calendarSection',
            'menu-seniority': 'senioritySection',
            'menu-settings': 'settingsSection',
            'menu-bajas': 'bajasSection'
        };


        // Settings State
        const defaultSettings = {
            instName: "Municipio de Toluca",
            instLogo: "Toluca-logo.png",
            signName1: "", signCargo1: "",
            signName2: "", signCargo2: "",
            catDirecciones: "ADMINISTRACIÓN,GESTIÓN AMBIENTAL,DIRECCIÓN GENERAL DE MEDIO AMBIENTE,JURÍDICA E INSPECCIÓN AMBIENTAL,SERVICIOS PÚBLICOS,TESORERÍA,SEGURIDAD PÚBLICA,OBRA PÚBLICA,CATASTRO",
            catDepartamentos: "Administración de Personal,Atención Canina y Felina,Centro de Control y Bienestar Animal,Cambio Climático,Forestación,Normatividad,Inspección Ambiental,Impacto Ambiental",
            catComisiones: "N/A,COMISIÓN DE HACIENDA,COMISIÓN DE MEDIO AMBIENTE,COMISIÓN DE SALUD,COMISIÓN DE CULTURA",
            ruleTolerance: 15,
            holidays: [],
            userName: "Lulabel",
            userEmail: "",
            appPassword: "",
            geminiApiKey: ""
        };

        const storedSettings = JSON.parse(localStorage.getItem('hr_settings')) || {};
        let hrSettings = { ...defaultSettings, ...storedSettings };
        validateAccess();

        // Switch Tabs in Settings
        window.switchSettingsTab = function (tabId) {
            document.querySelectorAll('.settings-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        };

        // Save All Settings
        window.saveAllSettings = async function (btnElement) {
            const btn = btnElement || document.getElementById('saveSettingsBtn');
            if (btn) btn.classList.add('btn-loading');

            try {
                // 1. Capturar valores
                hrSettings.instName = document.getElementById('set-inst-name').value;
                hrSettings.instLogo = document.getElementById('set-inst-logo').value;
                hrSettings.signName1 = document.getElementById('set-sign-name1').value;
                hrSettings.signCargo1 = document.getElementById('set-sign-cargo1').value;
                hrSettings.signName2 = document.getElementById('set-sign-name2').value;
                hrSettings.signCargo2 = document.getElementById('set-sign-cargo2').value;
                hrSettings.catDirecciones = document.getElementById('set-cat-direcciones').value;
                hrSettings.catDepartamentos = document.getElementById('set-cat-departamentos').value;
                hrSettings.catComisiones = document.getElementById('set-cat-comisiones').value;
                hrSettings.ruleTolerance = parseInt(document.getElementById('set-rule-tolerance').value);
                hrSettings.userName = document.getElementById('set-user-name').value;
                hrSettings.userEmail = document.getElementById('set-user-email').value;
                hrSettings.appPassword = document.getElementById('set-app-password').value;
                hrSettings.geminiApiKey = document.getElementById('set-gemini-key').value.trim();

                // 2. Guardar en LOCAL de inmediato
                localStorage.setItem('hr_settings', JSON.stringify(hrSettings));
                populateCatalogs();
                validateAccess(); // Activar contraseña si se puso una nueva

                // 3. Feedback visual rápido
                if (btn) {
                    btn.classList.remove('btn-loading');
                    btn.classList.add('btn-success-active');
                    const originalText = btn.innerText;
                    btn.innerText = "¡Guardado!";
                    setTimeout(() => {
                        btn.classList.remove('btn-success-active');
                        btn.innerText = originalText;
                    }, 2000);
                }

                // 4. Intentar Nube en segundo plano
                try {
                    await pushDataToCloud();
                    showToast("Sincronizado con la nube", "success");
                } catch (e) {
                    console.warn("Fallo de nube (esperado si no hay cuota):", e);
                    showToast("Guardado local (Nube offline momentáneamente)", "info");
                }

            } catch (err) {
                showToast("Error al procesar ajustes", "error");
                console.error(err);
                if (btn) btn.classList.remove('btn-loading');
            }
        };

        // Load settings to form
        function loadSettingsToForm() {
            document.getElementById('set-inst-name').value = hrSettings.instName;
            document.getElementById('set-inst-logo').value = hrSettings.instLogo;
            document.getElementById('set-sign-name1').value = hrSettings.signName1 || "";
            document.getElementById('set-sign-cargo1').value = hrSettings.signCargo1 || "";
            document.getElementById('set-sign-name2').value = hrSettings.signName2 || "";
            document.getElementById('set-sign-cargo2').value = hrSettings.signCargo2 || "";
            document.getElementById('set-cat-direcciones').value = hrSettings.catDirecciones;
            document.getElementById('set-cat-departamentos').value = hrSettings.catDepartamentos;
            document.getElementById('set-cat-comisiones').value = hrSettings.catComisiones;
            document.getElementById('set-rule-tolerance').value = hrSettings.ruleTolerance;
            document.getElementById('set-user-name').value = hrSettings.userName;
            document.getElementById('set-user-email').value = hrSettings.userEmail || "";
            document.getElementById('set-app-password').value = hrSettings.appPassword || "";
            document.getElementById('set-gemini-key').value = hrSettings.geminiApiKey || "";
            renderHolidays();
        }

        // Logic for Locking and Password
        window.checkPassword = function () {
            const val = document.getElementById('loginPass').value;
            if (val === hrSettings.appPassword) {
                document.getElementById('loginOverlay').style.display = 'none';
                sessionStorage.setItem('hr_auth', 'unlocked');
            } else {
                const err = document.getElementById('loginError');
                err.style.display = 'block';
                setTimeout(() => err.style.display = 'none', 3000);
            }
        };

        function validateAccess() {
            const hasPass = hrSettings.appPassword && hrSettings.appPassword.trim() !== '';
            const overlay = document.getElementById('loginOverlay');

            if (hasPass) {
                const isAuth = sessionStorage.getItem('hr_auth');
                if (isAuth === 'unlocked') {
                    overlay.style.display = 'none';
                } else {
                    overlay.style.display = 'flex';
                }
            } else {
                // Si no hay contraseña configurada, escondemos el bloqueo
                overlay.style.display = 'none';
            }
        }

        // Holidays Logic
        window.addHoliday = function () {
            const date = document.getElementById('new-holiday-date').value;
            if (date && !hrSettings.holidays.includes(date)) {
                hrSettings.holidays.push(date);
                renderHolidays();
            }
        };

        window.removeHoliday = function (date) {
            hrSettings.holidays = hrSettings.holidays.filter(d => d !== date);
            renderHolidays();
        };

        function renderHolidays() {
            const list = document.getElementById('holidays-list');
            list.innerHTML = '';
            hrSettings.holidays.sort().forEach(date => {
                const tag = document.createElement('div');
                tag.className = 'holiday-tag';
                tag.innerHTML = `${date} <button onclick="window.removeHoliday('${date}')">×</button>`;
                list.appendChild(tag);
            });
        }

        window.logoutSystem = function () {
            sessionStorage.removeItem('hr_auth');
            location.reload();
        };

        // Backup Logic
        window.exportFullBackup = function () {
            const data = {
                employees: employees,
                attendance: JSON.parse(localStorage.getItem('hr_attendance')) || {},
                settings: hrSettings,
                bajas: bajas
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HR_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };

        window.sendEmailBackup = async function (isAuto = false) {
            if (!hrSettings.userEmail) {
                if (!isAuto) alert("Por favor, configura tu correo electrónico en la pestaña de Perfil.");
                return;
            }

            const data = {
                date: new Date().toLocaleString(),
                employeeCount: employees.length,
                bajasCount: bajas.length,
                url: window.location.href,
                recipient: hrSettings.userEmail
            };

            // Using EmailJS with a robust direct-link technique or mailto fallback
            try {
                // If the user has configured EmailJS tokens, this would be:
                // emailjs.send("service_id", "template_id", data);

                // For now, we provide a sophisticated mailto fallback that functions as a pro trigger
                const subject = encodeURIComponent(`SIRECOA - Respaldo de Datos (${data.date})`);
                const body = encodeURIComponent(
                    `Hola ${hrSettings.userName},\n\n` +
                    `Se ha generado un respaldo de seguridad del sistema SIRECOA.\n\n` +
                    `RESUMEN:\n` +
                    `- Empleados Activos: ${data.employeeCount}\n` +
                    `- Registros en Bajas: ${data.bajasCount}\n` +
                    `- Fecha: ${data.date}\n\n` +
                    `Los datos están sincronizados en la nube de Firebase. Si deseas descargar la copia física (.json), entra a la sección de Ajustes > Respaldo en la aplicación:\n` +
                    `${data.url}\n\n` +
                    `Atentamente,\nLulaBot Analyst`
                );

                window.location.href = `mailto:${hrSettings.userEmail}?subject=${subject}&body=${body}`;
                if (!isAuto) alert("Se ha preparado el correo de respaldo. Por favor, pulsa 'Enviar' en tu aplicación de correo.");

            } catch (error) {
                console.error("Error sending backup email:", error);
            }
        };

        window.resetSystemData = async function () {
            if (confirm("¿ESTÁS COMPLETAMENTE SEGURO? Se borrarán todos los empleados y asistencias definitivamente de este equipo y de la nube.")) {
                employees = [];
                bajas = [];
                attendanceRecord = {};
                localStorage.removeItem('hr_employees');
                localStorage.removeItem('hr_attendance');
                localStorage.removeItem('hr_bajas');
                await pushDataToCloud();
                location.reload();
            }
        };

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const id = item.id;
                hideAllSections();
                item.classList.add('active');

                const targetId = sectionsMap[id];
                const section = document.getElementById(targetId);

                if (targetId === 'homeSection') {
                    section.style.display = 'flex';
                } else {
                    section.style.display = 'block';
                }

                // Sub-renders
                if (id === 'menu-employees') renderTable();
                if (id === 'menu-attendance') renderAttendance();
                if (id === 'menu-reports') {
                    const now = new Date();
                    document.getElementById('reportMonth').value = now.getMonth();
                    document.getElementById('reportYear').value = now.getFullYear();
                    window.updateReportFilters();
                }
                if (id === 'menu-calendar') renderCalendar();
                if (id === 'menu-seniority') {
                    renderSeniority();
                }
                if (id === 'menu-settings') {
                    loadSettingsToForm();
                }
                if (id === 'menu-bajas') {
                    renderBajas();
                }
            });
        });

        // Auto-update seniority every second while visible
        setInterval(() => {
            const senioritySection = document.getElementById('senioritySection');
            if (senioritySection && senioritySection.style.display === 'block') {
                renderSeniority();
            }
        }, 1000);

        // Seniority Calculation Logic
        // Ultra-resilient date parsing: handles textual dates, multiple separators, and shorthand years
        window.parseDate = function (dateStr) {
            if (!dateStr || dateStr === '-' || dateStr === 'null' || dateStr.trim() === '') return null;

            // 1. Pre-cleaning
            let clean = dateStr.toString().toLowerCase()
                .replace(/\s+/g, ' ')
                .replace(/[^0-9a-z\/\-]/g, '/') // Replace any non-alphanumeric with /
                .replace(/\/+/g, '/')           // Collapse multiple /
                .trim();

            // 2. Translate Spanish months
            const monthsSp = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            const monthsAbbr = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];

            monthsSp.forEach((m, i) => { if (clean.includes(m)) clean = clean.replace(m, (i + 1).toString()); });
            monthsAbbr.forEach((m, i) => { if (clean.includes(m)) clean = clean.replace(m, (i + 1).toString()); });

            // 3. Try splitting by common separators
            let pts = clean.split(/[\/\-\s]/).filter(p => p !== '');

            if (pts.length === 3) {
                let d, m, y;
                // Detect based on positions
                if (pts[0].length === 4) { // YYYY-MM-DD
                    y = parseInt(pts[0]); m = parseInt(pts[1]); d = parseInt(pts[2]);
                } else if (parseInt(pts[1]) > 12 && parseInt(pts[0]) <= 12) { // US Format fallback MM/DD/YYYY
                    m = parseInt(pts[0]); d = parseInt(pts[1]); y = parseInt(pts[2]);
                } else { // Standard Mexican DD/MM/YYYY
                    d = parseInt(pts[0]); m = parseInt(pts[1]); y = parseInt(pts[2]);
                }

                if (y < 100) y += (y > 50 ? 1900 : 2000); // Handle YY shorthand

                if (!isNaN(d) && !isNaN(m) && !isNaN(y)) {
                    const res = new Date(y, m - 1, d);
                    if (!isNaN(res.getTime())) return res;
                }
            }

            // Final fallback to native
            const fallback = new Date(dateStr);
            return isNaN(fallback.getTime()) ? null : fallback;
        };

        window.calculateDiff = function (startDate) {
            if (!startDate) return '-';
            const start = window.parseDate(startDate);
            if (!start) return 'Formato inválido';

            // Normalization to midnight for fair comparison
            start.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let years = today.getFullYear() - start.getFullYear();
            let months = today.getMonth() - start.getMonth();
            let days = today.getDate() - start.getDate();

            if (days < 0) {
                months--;
                days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }

            if (years < 0) return '0 Años, 0 Meses, 0 Días (Nuevo ingreso)';

            const yLabel = years === 1 ? 'Año' : 'Años';
            const mLabel = months === 1 ? 'Mes' : 'Meses';
            const dLabel = days === 1 ? 'Día' : 'Días';

            return `${years} ${yLabel}, ${months} ${mLabel}, ${days} ${dLabel}`;
        };

        window.runManualCalculation = function () {
            const dateInput = document.getElementById('manualDateInput').value;
            if (!dateInput) {
                alert('Por favor selecciona una fecha');
                return;
            }
            const result = window.calculateDiff(dateInput);
            document.getElementById('manualResult').innerText = `Resultado: ${result}`;
        };

        window.renderSeniority = function () {
            const searchTerm = document.getElementById('senioritySearch').value.toLowerCase();
            const tbody = document.getElementById('seniorityTbody');
            tbody.innerHTML = '';

            const filtered = employees.filter(emp =>
                emp.nombre.toLowerCase().includes(searchTerm) ||
                emp.clave.toLowerCase().includes(searchTerm)
            );

            filtered.forEach(emp => {
                const altaOrig = window.calculateDiff(emp.fechaAlta);
                const altaAntig = window.calculateDiff(emp.fechaAntiguedad);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 1rem;">
                        <div style="font-weight: 700; color: var(--text-main);">${emp.nombre}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); font-family: monospace;">${emp.clave}</div>
                    </td>
                    <td style="text-align: center; border-left: 1px solid var(--border); font-family: monospace;">${emp.fechaAlta || '-'}</td>
                    <td style="text-align: center; font-weight: 600; color: #811231; background: rgba(129, 18, 49, 0.02);">${altaOrig}</td>
                    <td style="text-align: center; border-left: 1px solid var(--border); font-family: monospace;">${emp.fechaAntiguedad || '-'}</td>
                    <td style="text-align: center; font-weight: 600; color: #10b981; background: rgba(16, 185, 129, 0.02);">${altaAntig}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        document.getElementById('senioritySearch').addEventListener('input', window.renderSeniority);

        window.previewSeniorityPDF = function () {
            const table = document.getElementById('seniorityTable');
            const previewContent = document.getElementById('pdfContent');
            const title = "Reporte General de Antigüedad del Personal";

            previewContent.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #811231; padding-bottom: 15px; margin-bottom: 20px;">
                    <img src="Toluca-logo.png" style="height: 108px; width: auto;" alt="Logo Institucional">
                    <div style="text-align: right;">
                        <h1 style="color: #811231; font-size: 1.2rem; margin: 0;">${title}</h1>
                        <p style="color: #666; font-size: 0.8rem; margin: 5px 0 0 0;">Generado el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}</p>
                    </div>
                </div>
                
                <div style="min-height: 400px;">
                    <div style="overflow-x: auto;">
                        ${table.outerHTML}
                    </div>
                </div>

                <div style="margin-top: 60px; display: flex; justify-content: space-around; text-align: center;">
                    <div style="width: 250px;">
                        <div style="border-top: 1.5px solid #333; padding-top: 8px;">
                            <p style="font-weight: 700; margin: 0; font-size: 0.9rem; color: #1e293b;">REVISÓ</p>
                            <p style="font-size: 0.75rem; color: #64748b; margin: 4px 0 0 0;">Nombre y Firma</p>
                        </div>
                    </div>
                    <div style="width: 250px;">
                        <div style="border-top: 1.5px solid #333; padding-top: 8px;">
                            <p style="font-weight: 700; margin: 0; font-size: 0.9rem; color: #1e293b;">DE CONFORMIDAD</p>
                            <p style="font-size: 0.75rem; color: #64748b; margin: 4px 0 0 0;">Nombre y Firma</p>
                        </div>
                    </div>
                </div>
            `;

            // Fix sticky/styles
            const tableClone = previewContent.querySelector('table');
            tableClone.style.width = '100%';
            tableClone.style.borderCollapse = 'collapse';
            tableClone.querySelectorAll('th, td').forEach(el => {
                el.style.position = 'static';
                el.style.color = 'black';
                el.style.border = '1px solid #ddd';
                el.style.padding = '8px';
            });

            document.getElementById('previewModal').style.display = 'flex';
            setTimeout(() => document.getElementById('previewModal').classList.add('active'), 10);

            // Set flag to ensure correct orientation during export
            window.currentReportType = 'seniority';
        };

        // Modify exportToPDF to check orientation
        const originalExport = window.exportToPDF;
        window.exportToPDF = function () {
            const element = document.getElementById('pdfContent');
            const type = document.getElementById('reportType').value;
            const isSeniority = window.currentReportType === 'seniority';

            const opt = {
                margin: 10,
                filename: isSeniority ? 'Reporte_Antigüedad.pdf' : `Reporte_Asistencia.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: (type === 'monthly' || isSeniority) ? 'landscape' : 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                window.closePreviewModal();
                window.currentReportType = null;
            });
        };

        // Calendar Logic 2026
        const HOLIDAYS = [
            '2026-01-01', // Año Nuevo
            '2026-02-02', // Aniv. Constitución (5 Feb)
            '2026-03-02', // Aniv. EdoMex
            '2026-03-16', // Natalicio Juárez (21 Mar)
            '2026-04-02', '2026-04-03', // Suspensión de labores
            '2026-05-01', // Día del Trabajo
            '2026-05-05', // Batalla de Puebla
            '2026-09-16', // Independencia
            '2026-11-02', // Día de Muertos
            '2026-11-16', // Rev. Mexicana (20 Nov)
            '2026-12-25'  // Navidad
        ];

        const VACATIONS = [
            // Period 1: 2-6 Jan
            ...generateDateRange('2026-01-02', '2026-01-06'),
            // Period 2: 30 Mar - 1 Apr
            ...generateDateRange('2026-03-30', '2026-04-01'),
            // Period 3: 20-28 Jul
            ...generateDateRange('2026-07-20', '2026-07-28'),
            // Period 4: 21-31 Dec
            ...generateDateRange('2026-12-21', '2026-12-31')
        ];

        function generateDateRange(start, end) {
            const dates = [];
            let current = new Date(start + 'T00:00:00');
            const last = new Date(end + 'T00:00:00');
            while (current <= last) {
                dates.push(current.toISOString().split('T')[0]);
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        const MONTH_NAMES = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            for (let m = 0; m < 12; m++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-container';

                const header = document.createElement('div');
                header.className = 'month-header';
                header.innerText = MONTH_NAMES[m];
                monthDiv.appendChild(header);

                const daysHeader = document.createElement('div');
                daysHeader.className = 'days-header';
                ['D', 'L', 'M', 'M', 'J', 'V', 'S'].forEach(d => {
                    const dDiv = document.createElement('div');
                    dDiv.innerText = d;
                    daysHeader.appendChild(dDiv);
                });
                monthDiv.appendChild(daysHeader);

                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';

                const firstDay = new Date(2026, m, 1).getDay();
                const daysInMonth = new Date(2026, m + 1, 0).getDate();

                // Empty cells
                for (let i = 0; i < firstDay; i++) {
                    const empty = document.createElement('div');
                    empty.className = 'day-cell empty';
                    daysGrid.appendChild(empty);
                }

                // Days
                for (let d = 1; d <= daysInMonth; d++) {
                    const day = document.createElement('div');
                    day.className = 'day-cell';
                    day.innerText = d;

                    const dateStr = `2026-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                    if (HOLIDAYS.includes(dateStr) || hrSettings.holidays.includes(dateStr)) {
                        day.classList.add('holiday');
                    }
                    if (VACATIONS.includes(dateStr)) {
                        day.classList.add('vacation');
                    }

                    // --- Dashboard Logic (Mapa de Calor) ---
                    const records = attendanceRecord[dateStr];
                    if (records) {
                        day.classList.add('has-data');
                        let countPres = 0;
                        let countLate = 0;
                        let countAbsent = 0;

                        Object.values(records).forEach(status => {
                            if (status === 'asistencia') countPres++;
                            else if (status === 'retardo') countLate++;
                            else if (status === 'falta' || status === 'omision_e' || status === 'omision_s') countAbsent++;
                        });

                        // Visual dots
                        const dotsCont = document.createElement('div');
                        dotsCont.className = 'attendance-dots';
                        if (countPres > 0) dotsCont.innerHTML += '<div class="dot present"></div>';
                        if (countLate > 0) dotsCont.innerHTML += '<div class="dot late"></div>';
                        if (countAbsent > 0) dotsCont.innerHTML += '<div class="dot absent"></div>';
                        day.appendChild(dotsCont);

                        // Tooltip
                        const tooltip = document.createElement('div');
                        tooltip.className = 'tooltip';
                        tooltip.innerHTML = `
                            <strong>Resumen ${d} de ${MONTH_NAMES[m]}</strong><br>
                            ✅ Presentes: ${countPres}<br>
                            ⚠️ Retardos: ${countLate}<br>
                            ❌ Ausencias: ${countAbsent}
                        `;
                        day.appendChild(tooltip);
                    }

                    daysGrid.appendChild(day);
                }

                monthDiv.appendChild(daysGrid);
                grid.appendChild(monthDiv);
            }
        }

        // Función centralizada para guardar y refrescar
        async function saveAndRender(silent = false) {
            try {
                localStorage.setItem('hr_employees', JSON.stringify(employees));
                localStorage.setItem('hr_bajas', JSON.stringify(bajas));

                // Intentar sincronizar pero no bloquear si falla
                try {
                    await pushDataToCloud();
                    if (!silent) showToast("Datos sincronizados con éxito", "success");
                } catch (e) {
                    console.warn("Fallo sincronización nube:", e);
                    if (!silent) showToast("Guardado localmente. Nube dice: " + e.message, "info");
                }

                const searchVal = document.getElementById('search')?.value || '';
                renderTable(searchVal);
                renderBajas();
            } catch (e) {
                console.error('Error en saveAndRender:', e);
                showToast("Error crítico al guardar datos", "error");
            }
        }

        function showToast(message, type = 'info') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Renderizado ultra-compatible con gestión de índices correcta
        function renderTable(filter = '') {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const term = filter.toLowerCase().trim();

            // Iteramos sobre el arreglo original pero mantenemos el índice real
            employees.forEach((emp, idx) => {
                const nombre = (emp.nombre || '').toLowerCase();
                const clave = (emp.clave || '').toLowerCase();

                if (nombre.includes(term) || clave.includes(term)) {
                    const tr = document.createElement('tr');
                    tr.title = `Dirección: ${emp.direccion || ''} | Depto: ${emp.departamento || ''} | Comisión: ${emp.comision || ''}`;
                    tr.innerHTML = `
                        <td style="font-weight: 600;">${emp.clave || ''}</td>
                        <td>${emp.nombre || ''}</td>
                        <td><span class="badge badge-info">${emp.tipo || ''}</span></td>
                        <td style="font-size: 0.75rem;">${emp.direccion || '-'}</td>
                        <td style="font-size: 0.75rem;">${emp.departamento || '-'}</td>
                        <td>${emp.comision || '-'}</td>
                        <td style="white-space: nowrap;">${emp.fechaAlta || '-'}</td>
                        <td style="white-space: nowrap;">${emp.fechaAntiguedad || '-'}</td>
                        <td><span class="badge ${emp.comisionado ? 'badge-success' : ''}" style="background: ${emp.comisionado ? 'rgba(34, 197, 94, 0.1)' : 'rgba(100, 116, 139, 0.1)'}; color: ${emp.comisionado ? '#22c55e' : '#64748b'};">
                            ${emp.comisionado ? 'Comisionado' : 'Activo'}
                        </span></td>
                        <td>
                            <div class="actions-cell">
                                <button class="btn-ghost" onclick="window.editEmployeeManual(${idx})" title="Editar">
                                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                </button>
                                <button class="btn-ghost" onclick="window.deleteEmployeeManual(${idx})" title="Eliminar" style="color: #ef4444;">
                                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        // Funciones Globales (asignadas explícitamente a window)


        // Modal Handling
        let pendingDeleteIdx = null;
        const deleteModal = document.getElementById('deleteModal');

        window.deleteEmployeeManual = function (idx) {
            pendingDeleteIdx = idx;
            deleteModal.style.display = 'flex';
            setTimeout(() => deleteModal.classList.add('active'), 10);
        };

        window.closeDeleteModal = function () {
            deleteModal.classList.remove('active');
            setTimeout(() => deleteModal.style.display = 'none', 200);
            pendingDeleteIdx = null;
        };

        window.confirmDelete = function () {
            if (pendingDeleteIdx !== null) {
                const emp = employees[pendingDeleteIdx];
                emp.fechaBaja = new Date().toLocaleDateString();
                bajas.push(emp);
                employees.splice(pendingDeleteIdx, 1);

                localStorage.setItem('hr_bajas', JSON.stringify(bajas));
                saveAndRender();
                closeDeleteModal();
            }
        };

        window.renderBajas = function () {
            const tbody = document.getElementById('bajasTbody');
            const term = document.getElementById('bajasSearch').value.toLowerCase();
            tbody.innerHTML = '';

            const filtered = bajas.filter(b =>
                b.nombre.toLowerCase().includes(term) ||
                b.clave.toLowerCase().includes(term)
            );

            filtered.forEach((emp, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight: 600;">${emp.clave}</td>
                    <td>${emp.nombre}</td>
                    <td>${emp.departamento}</td>
                    <td>${emp.fechaBaja || 'N/A'}</td>
                    <td style="text-align: right;">
                        <button class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;" onclick="window.restoreEmployee(${idx})">Reintegrar</button>
                        <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #ef4444; color: white; margin-left: 0.5rem;" onclick="window.permDeleteBaja(${idx})">Eliminar Permanente</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.restoreEmployee = function (idx) {
            const emp = bajas[idx];
            delete emp.fechaBaja;
            employees.push(emp);
            bajas.splice(idx, 1);

            localStorage.setItem('hr_bajas', JSON.stringify(bajas));
            saveAndRender();
            renderBajas();
            alert("Empleado reintegrado al directorio activo.");
        };

        window.permDeleteBaja = function (idx) {
            if (confirm("¿Estás seguro de eliminar permanentemente a este empleado de los registros de baja?")) {
                bajas.splice(idx, 1);
                localStorage.setItem('hr_bajas', JSON.stringify(bajas));
                renderBajas();
            }
        };

        // Eventos de Formulario
        const form = document.getElementById('employeeForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const btnText = document.getElementById('btnText');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.querySelector('#employeeForm button[type="submit"]');
            btn.classList.add('btn-loading');

            try {
                const data = {
                    clave: document.getElementById('clave').value,
                    nombre: document.getElementById('nombre').value,
                    tipo: document.getElementById('tipo').value,
                    direccion: document.getElementById('direccion').value,
                    departamento: document.getElementById('departamento').value,
                    comision: document.getElementById('comision').value,
                    fechaAlta: document.getElementById('fechaAlta').value,
                    fechaAntiguedad: document.getElementById('fechaAntiguedad').value,
                    comisionado: document.getElementById('comisionado').checked
                };

                if (editingId !== null) {
                    employees[editingId] = data;
                    editingId = null;
                    document.getElementById('btnText').innerText = 'Registrar Empleado';
                    document.getElementById('cancelBtn').style.display = 'none';
                    document.querySelector('.card').classList.remove('edit-mode');
                    showToast("Información actualizada", "success");
                } else {
                    employees.push(data);
                    showToast("Empleado registrado", "success");
                }

                await saveAndRender(true);

                // Visual feedback pop
                btn.classList.add('btn-success-active');
                setTimeout(() => btn.classList.remove('btn-success-active'), 1500);

                form.reset();
                window.toggleRegisterForm(); // Close form after success
            } catch (err) {
                showToast("Error al guardar empleado", "error");
            } finally {
                btn.classList.remove('btn-loading');
            }
        });



        // Buscador Directorio
        document.getElementById('search').addEventListener('input', (e) => {
            renderTable(e.target.value);
        });

        // Buscador Asistencia
        document.getElementById('attendanceSearch').addEventListener('input', () => {
            renderAttendance();
        });

        // Toggle Form Logic
        window.toggleRegisterForm = function () {
            const container = document.getElementById('registrationContainer');
            const btn = document.getElementById('toggleFormBtn');
            const isVisible = container.style.display === 'block';

            if (isVisible) {
                if (editingId !== null && !confirm("Estás en modo edición. ¿Seguro que quieres cerrar el formulario? Se perderán los cambios no guardados.")) {
                    return;
                }
                container.style.display = 'none';
                btn.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Nuevo Empleado`;
                form.reset();
                editingId = null;
                document.getElementById('formTitle').innerText = 'Registro de Nuevo Empleado';
                document.getElementById('btnText').innerText = 'Registrar Empleado';
            } else {
                container.style.display = 'block';
                btn.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Cerrar Formulario`;
            }
        };

        // Helper para asegurar formato YYYY-MM-DD para inputs tipo date
        function ensureISODate(dateStr) {
            if (!dateStr) return '';
            // Si ya es YYYY-MM-DD (ej: 2024-01-31)
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;

            // Si es DD/MM/YYYY (ej: 31/01/2024)
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // Asumimos DD, MM, YYYY
                const d = parts[0].padStart(2, '0');
                const m = parts[1].padStart(2, '0');
                const y = parts[2];
                if (y.length === 4) return `${y}-${m}-${d}`;
            }

            // Intento de parseo nativo si nada funciona
            try {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    return d.toISOString().split('T')[0];
                }
            } catch (e) { }

            return '';
        }

        window.editEmployeeManual = function (idx) {
            const emp = employees[idx];
            if (!emp) return;

            // Aseguramos que el "Tipo" también esté en su select (si es valor custom)
            const tipoSelect = document.getElementById('tipo');
            const tiposBase = ["Funcionario", "Generales", "Sindicalizado", "Confianza"];
            if (emp.tipo && !tiposBase.includes(emp.tipo)) {
                // Agregar opción temporal si no existe
                let exists = false;
                for (let opt of tipoSelect.options) {
                    if (opt.value === emp.tipo) { exists = true; break; }
                }
                if (!exists) {
                    const newOpt = document.createElement('option');
                    newOpt.value = emp.tipo;
                    newOpt.textContent = emp.tipo;
                    tipoSelect.appendChild(newOpt);
                }
            }

            // Pre-rellenar catálogos forzando los valores del empleado actual
            populateCatalogs({
                'direccion': emp.direccion,
                'departamento': emp.departamento,
                'comision': emp.comision
            });

            // Mostrar formulario
            const container = document.getElementById('registrationContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                document.getElementById('toggleFormBtn').innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Cerrar`;
            }

            editingId = idx;
            document.getElementById('clave').value = emp.clave || '';
            document.getElementById('nombre').value = emp.nombre || '';
            document.getElementById('tipo').value = emp.tipo || '';
            document.getElementById('direccion').value = emp.direccion || '';
            document.getElementById('departamento').value = emp.departamento || '';
            document.getElementById('comision').value = emp.comision || '';

            // Corregir fechas para que el input type="date" las reconozca
            document.getElementById('fechaAlta').value = ensureISODate(emp.fechaAlta);
            document.getElementById('fechaAntiguedad').value = ensureISODate(emp.fechaAntiguedad);

            document.getElementById('comisionado').checked = !!emp.comisionado;

            document.getElementById('formTitle').innerText = 'Editar Información de Empleado';
            document.getElementById('btnText').innerText = 'Guardar Cambios';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- Nuevas Funciones de CSV ---

        // Importar CSV
        document.getElementById('csvImport').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const text = event.target.result;
                const lines = text.split('\n');

                // Función para parsear CSV manejando comillas y comas internas
                function parseCSV(text) {
                    const rows = [];
                    const lines = text.split(/\r?\n/);

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const result = [];
                        let cell = '';
                        let inQuotes = false;

                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(cell.trim());
                                cell = '';
                            } else {
                                cell += char;
                            }
                        }
                        result.push(cell.trim());
                        rows.push(result);
                    }
                    return rows;
                }

                const rows = parseCSV(text);
                const newEmployees = [];

                rows.forEach((columns, index) => {
                    if (columns.length >= 5) {
                        // Evitamos encabezados comunes
                        if (index === 0 && columns[0].toLowerCase().includes('clave')) return;

                        newEmployees.push({
                            clave: columns[0] || '',
                            nombre: columns[1] || '',
                            tipo: columns[2] || '',
                            direccion: columns[3] || '',
                            departamento: columns[4] || '',
                            comision: columns[5] || '',
                            fechaAlta: columns[6] || '',
                            fechaAntiguedad: columns[7] || '',
                            comisionado: columns[8] ? columns[8].toLowerCase() === 'true' || columns[8] === '1' : false
                        });
                    }
                });

                if (newEmployees.length > 0) {
                    if (confirm(`Se encontraron ${newEmployees.length} empleados. ¿Deseas agregarlos al directorio actual?`)) {
                        employees = [...employees, ...newEmployees];
                        saveAndRender();
                        showToast(`Se importaron ${newEmployees.length} registros`, "success");
                    }
                } else {
                    showToast("No se encontraron datos válidos en el CSV", "error");
                }
                e.target.value = ''; // Reset input
            };
            reader.readAsText(file);
        });

        // Exportar CSV
        window.exportCSV = function () {
            if (employees.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Clave,Nombre,Tipo,Direccion,Departamento,Comision,FechaAlta,FechaAntiguedad,Comisionado\n";

            employees.forEach(emp => {
                const row = [
                    `"${emp.clave}"`,
                    `"${emp.nombre}"`,
                    `"${emp.tipo}"`,
                    `"${emp.direccion}"`,
                    `"${emp.departamento}"`,
                    `"${emp.comision || ''}"`,
                    `"${emp.fechaAlta || ''}"`,
                    `"${emp.fechaAntiguedad || ''}"`,
                    emp.comisionado
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "directorio_empleados_2026.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Limpiar Directorio
        window.clearEmployees = function () {
            if (confirm('¿ESTÁS ABSOLUTAMENTE SEGURO? Esta acción borrará TODO el directorio de empleados permanentemente.')) {
                employees = [];
                saveAndRender();
                showToast("Directorio vaciado", "info");
            }
        };

        // Initialize date
        document.getElementById('attendanceDate').valueAsDate = new Date();


        const STATUS_LABELS = {
            'A': 'Asistencia',
            'F': 'Falta',
            'V': 'Vacaciones',
            'I': 'Incapacidad',
            'P': 'Permiso',
            'FG': 'Falta Justificada'
        };

        function isWeekend(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Use T00:00:00 to avoid timezone issues
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday is 0, Saturday is 6
        }

        window.renderAttendance = function () {
            const tbody = document.getElementById('attendanceTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const term = document.getElementById('attendanceSearch').value.toLowerCase().trim();
            const date = document.getElementById('attendanceDate').value;
            const dayRecord = attendanceRecord[date] || {};

            const ATTENDANCE_STATUSES = [
                { id: 'laboral', label: 'Día laboral', color: '#22c55e', short: 'DL' },
                { id: 'economico', label: 'Día Económico', color: '#eab308', short: 'DE' },
                { id: 'vac_abril', label: 'Vac. Ant. Abril', color: '#f97316', short: 'VA' },
                { id: 'vac_julio', label: 'Vac. Ant. Julio', color: '#f59e0b', short: 'VJ' },
                { id: 'vac_dic', label: 'Vac. Ant. Dic.', color: '#d97706', short: 'VD' },
                { id: 'vac_e1', label: 'Vac. E_1', color: '#84cc16', short: 'V1' },
                { id: 'vac_e2', label: 'Vac. E_2', color: '#65a30d', short: 'V2' },
                { id: 'vac_2p', label: 'Vac. 2_P', color: '#4d7c0f', short: 'VP' },
                { id: 'incapacidad', label: 'Día x Incapacidad', color: '#ef4444', short: 'IN' },
                { id: 'fallecimiento', label: 'Licencia x Fallecimiento', color: '#475569', short: 'LF' },
                { id: 'cumpleanos', label: 'Cumpleaños', color: '#ec4899', short: 'HB' },
                { id: 'txt', label: 'Día TxT', color: '#9333ea', short: 'TT' },
                { id: 'omision_e', label: 'Omisión de Entrada', color: '#f43f5e', short: 'OE' },
                { id: 'omision_s', label: 'Omisión de Salida', color: '#fb7185', short: 'OS' },
                { id: 'falta', label: 'Falta Injustificada', color: '#991b1b', short: 'FI' },
                { id: 'medico', label: 'Cuidado Médico', color: '#0ea5e9', short: 'CM' },
                { id: 'gravidez', label: 'Licencia x Gravidez', color: '#d946ef', short: 'LG' },
                { id: 'lactancia', label: 'Horas Lactancia', color: '#a855f7', short: 'HL' },
                { id: 'nacimiento', label: 'Licencia x Nacimiento', color: '#06b6d4', short: 'LN' },
                { id: 'matrimonio', label: 'Licencia x Matrimonio', color: '#f472b6', short: 'LM' },
                { id: 'comision', label: 'Comisión', color: '#6366f1', short: 'CO' },
                { id: 'comision_s', label: 'Comisión Sindical', color: '#4f46e5', short: 'CS' },
                { id: 'lic_c_sueldo', label: 'Licencia C/Sueldo', color: '#10b981', short: 'LS' },
                { id: 'lic_s_sueldo', color: '#64748b', short: 'LX' },
                { id: 'baja', label: 'Baja', color: '#000000', short: 'BJ' }
            ];

            employees.forEach((emp) => {
                if (emp.nombre.toLowerCase().includes(term) || emp.clave.toLowerCase().includes(term)) {
                    const tr = document.createElement('tr');
                    const currentStatusId = dayRecord[emp.clave] || '';
                    const currentStatus = ATTENDANCE_STATUSES.find(s => s.id === currentStatusId);

                    let optionsHtml = '<option value="">- Seleccionar -</option>';
                    ATTENDANCE_STATUSES.forEach(status => {
                        optionsHtml += `<option value="${status.id}" ${currentStatusId === status.id ? 'selected' : ''}>${status.label}</option>`;
                    });

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight: 600;">${emp.nombre}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${emp.clave}</div>
                        </td>
                        <td>${emp.departamento || '-'}</td>
                        <td style="text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                                ${currentStatus ?
                            `<div class="status-indicator" style="background: ${currentStatus.color};">${currentStatus.short}</div>` :
                            `<div class="status-indicator pending">?</div>`
                        }
                                <select class="status-select" onchange="window.setStatus('${emp.clave}', this.value)">
                                    ${optionsHtml}
                                </select>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        };

        window.setStatus = function (clave, status) {
            const date = document.getElementById('attendanceDate').value;
            if (!attendanceRecord[date]) attendanceRecord[date] = {};
            attendanceRecord[date][clave] = status;
            renderAttendance();
        };

        function saveAttendanceLocal() {
            localStorage.setItem('hr_attendance', JSON.stringify(attendanceRecord));
        }

        window.saveAttendance = async function () {
            const btn = event.currentTarget || event.target;
            if (!btn) return;

            btn.classList.add('btn-loading');

            try {
                localStorage.setItem('hr_attendance', JSON.stringify(attendanceRecord));

                try {
                    await pushDataToCloud();
                    showToast("Asistencia sincronizada", "success");
                } catch (e) {
                    console.warn("Fallo sincronización nube:", e);
                    showToast("Guardado local. Nube dice: " + e.message, "info");
                }

                // Proactive LulaBot Diagnosis
                const seriousAnomalies = window.scanForSeriousAnomalies ? window.scanForSeriousAnomalies() : [];
                if (seriousAnomalies.length > 0) {
                    if (confirm(`🤖 LulaBot ha detectado ${seriousAnomalies.length} anomalías graves. ¿Deseas enviar el reporte?`)) {
                        window.sendAnomalyAlert(seriousAnomalies);
                    }
                }

                // Visual feedback pop
                btn.classList.add('btn-success-active');
                setTimeout(() => btn.classList.remove('btn-success-active'), 1500);
            } catch (err) {
                console.error(err);
                showToast("Error al guardar asistencia", "error");
            } finally {
                btn.classList.remove('btn-loading');
            }
        };

        window.scanForSeriousAnomalies = function () {
            const threshold = 3; // Gravity limit
            const anomalies = {};
            const recentDates = Object.keys(attendanceRecord).sort().slice(-30); // Last 30 recorded days

            recentDates.forEach(date => {
                Object.entries(attendanceRecord[date]).forEach(([clave, status]) => {
                    if (['falta', 'omision_e', 'omision_s'].includes(status)) {
                        anomalies[clave] = (anomalies[clave] || 0) + 1;
                    }
                });
            });

            return Object.entries(anomalies)
                .filter(([clave, count]) => count >= threshold)
                .map(([clave, count]) => {
                    const emp = employees.find(e => e.clave === clave);
                    return { clave, count, nombre: emp ? emp.nombre : 'Desconocido', depto: emp ? emp.departamento : 'N/A' };
                });
        };

        window.sendAnomalyAlert = function (anomalies) {
            if (!hrSettings.userEmail) {
                alert("Configura tu correo en Ajustes > Perfil para recibir estas alertas.");
                return;
            }

            const date = new Date().toLocaleDateString();
            const subject = encodeURIComponent(`🚨 ALERTA LULABOT: Anomalías de Asistencia Detectadas (${date})`);

            let report = `Hola ${hrSettings.userName},\n\n`;
            report += `LulaBot ha detectado patrones de asistencia que requieren atención administrativa inmediata:\n\n`;
            report += `RESUMEN DE INCIDENCIAS (Últimos 30 días registrados):\n`;
            report += `--------------------------------------------------\n`;

            anomalies.forEach(a => {
                report += `• ${a.nombre} (${a.clave})\n`;
                report += `  Área: ${a.depto}\n`;
                report += `  Total Incidencias: ${a.count} (Faltas/Omisiones)\n`;
                report += `--------------------------------------------------\n`;
            });

            report += `\nRECOMENDACIÓN:\n`;
            report += `Se sugiere realizar una entrevista administrativa con el personal mencionado o verificar los justificantes correspondientes.\n\n`;
            report += `Atentamente,\nLulaBot AI Security Analyst`;

            window.location.href = `mailto:${hrSettings.userEmail}?subject=${subject}&body=${encodeURIComponent(report)}`;
        };

        // Helper to load specific attendance date from Cloud when date picker changes
        window.loadAttendanceDay = async function () {
            const date = document.getElementById('attendanceDate').value;
            if (!date) return;

            try {
                const doc = await db.collection('sirecoa_attendance').doc(date).get();
                if (doc.exists) {
                    attendanceRecord[date] = doc.data().records;
                    localStorage.setItem('hr_attendance', JSON.stringify(attendanceRecord));
                }
                renderAttendance();
            } catch (error) {
                console.error('Error cargando asistencia del día:', error);
            }
        };

        document.getElementById('attendanceDate').addEventListener('change', window.loadAttendanceDay);

        // --- Reports Logic ---
        const ATTENDANCE_STATUSES = [
            { id: 'laboral', label: 'Día laboral', color: '#22c55e', short: 'DL' },
            { id: 'economico', label: 'Día Económico', color: '#eab308', short: 'DE' },
            { id: 'vac_abril', label: 'Vac. Ant. Abril', color: '#f97316', short: 'VA' },
            { id: 'vac_julio', label: 'Vac. Ant. Julio', color: '#f59e0b', short: 'VJ' },
            { id: 'vac_dic', label: 'Vac. Ant. Dic.', color: '#d97706', short: 'VD' },
            { id: 'vac_e1', label: 'Vac. E_1', color: '#84cc16', short: 'V1' },
            { id: 'vac_e2', label: 'Vac. E_2', color: '#65a30d', short: 'V2' },
            { id: 'vac_2p', label: 'Vac. 2_P', color: '#4d7c0f', short: 'VP' },
            { id: 'incapacidad', label: 'Día x Incapacidad', color: '#ef4444', short: 'IN' },
            { id: 'fallecimiento', label: 'Licencia x Fallecimiento', color: '#475569', short: 'LF' },
            { id: 'cumpleanos', label: 'Cumpleaños', color: '#ec4899', short: 'HB' },
            { id: 'txt', label: 'Día TxT', color: '#9333ea', short: 'TT' },
            { id: 'omision_e', label: 'Omisión de Entrada', color: '#f43f5e', short: 'OE' },
            { id: 'omision_s', label: 'Omisión de Salida', color: '#fb7185', short: 'OS' },
            { id: 'falta', label: 'Falta Injustificada', color: '#991b1b', short: 'FI' },
            { id: 'medico', label: 'Cuidado Médico', color: '#0ea5e9', short: 'CM' },
            { id: 'gravidez', label: 'Licencia x Gravidez', color: '#d946ef', short: 'LG' },
            { id: 'lactancia', label: 'Horas Lactancia', color: '#a855f7', short: 'HL' },
            { id: 'nacimiento', label: 'Licencia x Nacimiento', color: '#06b6d4', short: 'LN' },
            { id: 'matrimonio', label: 'Licencia x Matrimonio', color: '#f472b6', short: 'LM' },
            { id: 'comision', label: 'Comisión', color: '#6366f1', short: 'CO' },
            { id: 'comision_s', label: 'Comisión Sindical', color: '#4f46e5', short: 'CS' },
            { id: 'lic_c_sueldo', label: 'Licencia C/Sueldo', color: '#10b981', short: 'LS' },
            { id: 'lic_s_sueldo', label: 'Licencia S/Sueldo', color: '#64748b', short: 'LX' },
            { id: 'baja', label: 'Baja', color: '#000000', short: 'BJ' }
        ];

        window.generateReport = function () {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const thead = document.getElementById('reportsThead');
            const tbody = document.getElementById('reportsTbody');

            // Generate Headers
            let headerHtml = `<tr><th rowspan="2" style="min-width: 200px; position: sticky; left: 0; background: var(--bg-card); z-index: 10;">Empleado</th>`;
            for (let d = 1; d <= daysInMonth; d++) {
                headerHtml += `<th style="text-align: center; width: 30px;">${d}</th>`;
            }
            headerHtml += `<th colspan="${ATTENDANCE_STATUSES.length}" style="text-align: center;">Resumen de Conceptos</th></tr><tr>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dayName = ['D', 'L', 'M', 'M', 'J', 'V', 'S'][date.getDay()];
                headerHtml += `<th style="text-align: center; font-size: 0.6rem; background: ${date.getDay() === 0 || date.getDay() === 6 ? 'rgba(0,0,0,0.05)' : 'transparent'}">${dayName}</th>`;
            }
            ATTENDANCE_STATUSES.forEach(status => {
                headerHtml += `<th title="${status.label}" style="padding: 2px; font-size: 0.55rem; width: 25px; writing-mode: vertical-lr; transform: rotate(180deg); height: 80px;">${status.short}</th>`;
            });
            headerHtml += `</tr>`;
            thead.innerHTML = headerHtml;

            // Generate Body
            tbody.innerHTML = '';
            employees.forEach(emp => {
                const tr = document.createElement('tr');
                let rowHtml = `<td style="font-weight: 500; position: sticky; left: 0; background: var(--bg-card); z-index: 9; border-right: 1px solid var(--border);">${emp.nombre}</td>`;

                const counters = {};
                ATTENDANCE_STATUSES.forEach(s => counters[s.id] = 0);

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const statusId = (attendanceRecord[dateStr] && attendanceRecord[dateStr][emp.clave]) || '';
                    const status = ATTENDANCE_STATUSES.find(s => s.id === statusId);

                    if (statusId) counters[statusId]++;

                    const isWeekend = new Date(year, month, d).getDay() % 6 === 0;
                    rowHtml += `<td style="text-align: center; padding: 2px; background: ${isWeekend ? 'rgba(0,0,0,0.02)' : 'transparent'}">
                        ${status ? `<div style="width: 18px; height: 18px; border-radius: 3px; background: ${status.color}; color: white; display: inline-flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700;">${status.short}</div>` : ''}
                    </td>`;
                }

                ATTENDANCE_STATUSES.forEach(status => {
                    const count = counters[status.id];
                    rowHtml += `<td style="text-align: center; font-weight: 700; color: ${count > 0 ? status.color : '#cbd5e1'}; font-size: 0.7rem;">${count > 0 ? count : '-'}</td>`;
                });

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        };

        window.updateReportFilters = function () {
            const type = document.getElementById('reportType').value;
            document.getElementById('filterEmployee').style.display = type === 'employee' ? 'block' : 'none';
            document.getElementById('filterConcept').style.display = type === 'concept' ? 'block' : 'none';

            if (type === 'employee') {
                const select = document.getElementById('reportEmployeeSelect');
                select.innerHTML = employees.map(e => `<option value="${e.clave}">${e.nombre}</option>`).join('');
            }
            if (type === 'concept') {
                const select = document.getElementById('reportConceptSelect');
                select.innerHTML = ATTENDANCE_STATUSES.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
            }
        };

        window.generateReport = function () {
            const type = document.getElementById('reportType').value;
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const thead = document.getElementById('reportsThead');
            const tbody = document.getElementById('reportsTbody');

            if (type === 'monthly') {
                generateMonthlySummary(thead, tbody, month, year, daysInMonth);
            } else if (type === 'employee') {
                generateEmployeeDetail(thead, tbody, month, year, daysInMonth);
            } else if (type === 'concept') {
                generateConceptReport(thead, tbody, month, year, daysInMonth);
            }
        };

        function generateMonthlySummary(thead, tbody, month, year, daysInMonth) {
            // Generate Headers
            let headerHtml = `<tr><th rowspan="2" style="min-width: 200px; position: sticky; left: 0; background: var(--bg-card); z-index: 10;">Empleado</th>`;
            for (let d = 1; d <= daysInMonth; d++) {
                headerHtml += `<th style="text-align: center; width: 30px;">${d}</th>`;
            }
            headerHtml += `<th colspan="${ATTENDANCE_STATUSES.length}" style="text-align: center;">Resumen de Conceptos</th></tr><tr>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dayName = ['D', 'L', 'M', 'M', 'J', 'V', 'S'][date.getDay()];
                headerHtml += `<th style="text-align: center; font-size: 0.6rem; background: ${date.getDay() === 0 || date.getDay() === 6 ? 'rgba(0,0,0,0.05)' : 'transparent'}">${dayName}</th>`;
            }
            ATTENDANCE_STATUSES.forEach(status => {
                headerHtml += `<th title="${status.label}" style="padding: 2px; font-size: 0.55rem; width: 25px; writing-mode: vertical-lr; transform: rotate(180deg); height: 80px;">${status.short}</th>`;
            });
            headerHtml += `</tr>`;
            thead.innerHTML = headerHtml;

            // Generate Body
            tbody.innerHTML = '';
            employees.forEach(emp => {
                const tr = document.createElement('tr');
                let rowHtml = `<td style="font-weight: 500; position: sticky; left: 0; background: var(--bg-card); z-index: 9; border-right: 1px solid var(--border);">${emp.nombre}</td>`;

                const counters = {};
                ATTENDANCE_STATUSES.forEach(s => counters[s.id] = 0);

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const statusId = (attendanceRecord[dateStr] && attendanceRecord[dateStr][emp.clave]) || '';
                    const status = ATTENDANCE_STATUSES.find(s => s.id === statusId);

                    if (statusId) counters[statusId]++;

                    const isWeekend = new Date(year, month, d).getDay() % 6 === 0;
                    rowHtml += `<td style="text-align: center; padding: 2px; background: ${isWeekend ? 'rgba(0,0,0,0.02)' : 'transparent'}">
                        ${status ? `<div style="width: 18px; height: 18px; border-radius: 3px; background: ${status.color}; color: white; display: inline-flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700;">${status.short}</div>` : ''}
                    </td>`;
                }

                ATTENDANCE_STATUSES.forEach(status => {
                    const count = counters[status.id];
                    rowHtml += `<td style="text-align: center; font-weight: 700; color: ${count > 0 ? status.color : '#cbd5e1'}; font-size: 0.7rem;">${count > 0 ? count : '-'}</td>`;
                });

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        function generateEmployeeDetail(thead, tbody, month, year, daysInMonth) {
            const clave = document.getElementById('reportEmployeeSelect').value;
            const emp = employees.find(e => e.clave === clave);
            if (!emp) return;

            thead.innerHTML = `<tr><th>Día</th><th>Fecha</th><th>Estatus</th><th>Concepto</th></tr>`;
            tbody.innerHTML = '';

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const statusId = (attendanceRecord[dateStr] && attendanceRecord[dateStr][clave]) || '';
                const status = ATTENDANCE_STATUSES.find(s => s.id === statusId);
                const date = new Date(year, month, d);
                const dayName = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'][date.getDay()];

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d}</td>
                    <td>${dayName}, ${d} de ${MONTH_NAMES[month]}</td>
                    <td style="text-align: center;">
                        ${status ? `<div style="padding: 4px 10px; border-radius: 4px; background: ${status.color}; color: white; display: inline-block; font-size: 0.7rem; font-weight: 700;">${status.short}</div>` : '-'}
                    </td>
                    <td>${status ? status.label : 'Sin registro'}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function generateConceptReport(thead, tbody, month, year, daysInMonth) {
            const statusId = document.getElementById('reportConceptSelect').value;
            const status = ATTENDANCE_STATUSES.find(s => s.id === statusId);
            if (!status) return;

            thead.innerHTML = `<tr><th>Empleado</th><th>Departamento</th><th>Total de Días: ${status.label}</th></tr>`;
            tbody.innerHTML = '';

            employees.forEach(emp => {
                let count = 0;
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    if (attendanceRecord[dateStr] && attendanceRecord[dateStr][emp.clave] === statusId) {
                        count++;
                    }
                }

                if (count > 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight: 600;">${emp.nombre}</td>
                        <td>${emp.departamento}</td>
                        <td style="text-align: center;"><span class="badge" style="background: ${status.color}; color: white;">${count}</span></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            if (tbody.innerHTML === '') {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 2rem; color: var(--text-muted);">No se encontraron registros para este concepto en el mes seleccionado.</td></tr>`;
            }
        }

        window.previewPDF = function () {
            const table = document.getElementById('reportsTable');
            const type = document.getElementById('reportType').value;
            const month = document.getElementById('reportMonth').options[document.getElementById('reportMonth').selectedIndex].text;
            const year = document.getElementById('reportYear').value;
            const previewContent = document.getElementById('pdfContent');

            let title = "Reporte de Asistencia";
            if (type === 'monthly') title = `Resumen Mensual de Asistencia - ${month} ${year}`;
            if (type === 'employee') title = `Reporte Individual: ${document.getElementById('reportEmployeeSelect').options[document.getElementById('reportEmployeeSelect').selectedIndex].text} - ${month} ${year}`;
            if (type === 'concept') title = `Reporte por Concepto: ${document.getElementById('reportConceptSelect').options[document.getElementById('reportConceptSelect').selectedIndex].text} - ${month} ${year}`;

            previewContent.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #811231; padding-bottom: 15px; margin-bottom: 20px;">
                    <img src="${hrSettings.instLogo}" style="height: 108px; width: auto;" alt="Logo" onerror="this.src='Toluca-logo.png'">
                    <div style="text-align: right;">
                        <h1 style="color: #811231; font-size: 1.2rem; margin: 0; text-transform: uppercase;">${hrSettings.instName}</h1>
                        <h2 style="font-size: 1rem; margin: 5px 0 0 0;">${title}</h2>
                        <p style="color: #666; font-size: 0.8rem; margin: 5px 0 0 0;">Generado el ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
                
                <div style="min-height: 400px; padding-bottom: 40px;">
                    <div style="overflow-x: auto;">
                        ${table.outerHTML}
                    </div>
                </div>

                <div style="margin-top: 60px; display: flex; justify-content: space-around; text-align: center; page-break-inside: avoid;">
                    <div style="width: 250px;">
                        <div style="border-top: 1.5px solid #333; padding-top: 8px;">
                            <p style="font-weight: 700; margin: 0; font-size: 0.9rem; color: #1e293b;">${hrSettings.signName1 || 'ELABORÓ'}</p>
                            <p style="font-size: 0.75rem; color: #64748b; margin: 4px 0 0 0;">${hrSettings.signCargo1 || 'Cargo'}</p>
                        </div>
                    </div>
                    <div style="width: 250px;">
                        <div style="border-top: 1.5px solid #333; padding-top: 8px;">
                            <p style="font-weight: 700; margin: 0; font-size: 0.9rem; color: #1e293b;">${hrSettings.signName2 || 'AUTORIZÓ'}</p>
                            <p style="font-size: 0.75rem; color: #64748b; margin: 4px 0 0 0;">${hrSettings.signCargo2 || 'Cargo'}</p>
                        </div>
                    </div>
                </div>
            `;

            // Fix sticky styles for PDF output
            const tableClone = previewContent.querySelector('table');
            tableClone.querySelectorAll('th, td').forEach(el => {
                el.style.position = 'static';
                el.style.color = 'black';
                el.style.border = '1px solid #ddd';
            });

            document.getElementById('previewModal').style.display = 'flex';
            setTimeout(() => document.getElementById('previewModal').classList.add('active'), 10);
        };

        window.closePreviewModal = function () {
            document.getElementById('previewModal').classList.remove('active');
            setTimeout(() => document.getElementById('previewModal').style.display = 'none', 200);
        };

        window.exportToPDF = function () {
            const element = document.getElementById('pdfContent');
            const type = document.getElementById('reportType').value;
            const month = document.getElementById('reportMonth').options[document.getElementById('reportMonth').selectedIndex].text;

            const opt = {
                margin: 10,
                filename: `Reporte_Asistencia_${type}_${month}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: type === 'monthly' ? 'landscape' : 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                window.closePreviewModal();
            });
        };

        // Populate Catalogs from Settings
        function populateCatalogs(forceValues = {}) {
            const sels = {
                'direccion': hrSettings.catDirecciones,
                'departamento': hrSettings.catDepartamentos,
                'comision': hrSettings.catComisiones
            };

            for (const [id, values] of Object.entries(sels)) {
                const select = document.getElementById(id);
                if (!select) continue;

                // Capturar el valor que queremos que quede seleccionado al final
                const targetVal = forceValues[id] || select.value;

                // Reset select
                select.innerHTML = '<option value="" disabled>Seleccionar...</option>';
                if (id === 'comision') select.innerHTML += '<option value="N/A">N/A</option>';

                const availableOptions = values.split(',').map(v => v.trim()).filter(v => v);

                // Si estamos editando y el valor actual NO está en el catálogo, lo agregamos para no perderlo
                if (targetVal && targetVal !== "" && !availableOptions.includes(targetVal)) {
                    availableOptions.unshift(targetVal);
                }

                availableOptions.forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = val;
                    select.appendChild(opt);
                });

                // Forzar la selección del valor esperado
                if (targetVal) {
                    select.value = targetVal;
                } else {
                    select.selectedIndex = 0;
                }
            }
        }

        // Initialize App
        function initApp() {
            // Update Welcome Name
            const welcome = document.getElementById('welcomeMessage');
            if (welcome) welcome.textContent = `${hrSettings.userName}, bienvenida al panel de control.`;

            populateCatalogs();
            renderAll();
            validateAccess();

            // Aseguramos que solo Inicio sea visible al arrancar
            hideAllSections();
            document.getElementById('homeSection').style.display = 'flex';
            document.getElementById('menu-home').classList.add('active');
        }

        initApp();

        // --- ChatBot Logic ---
        window.toggleChat = function () {
            const win = document.getElementById('chat-window');
            const isVisible = win.style.display === 'flex';
            win.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) document.getElementById('chat-input').focus();
        };

        window.sendChatMessage = async function () {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';

            const loadingId = 'msg-' + Date.now();
            addMessage('LulaBot está pensando...', 'bot', loadingId);

            try {
                const response = await getSmartResponse(text);
                updateMessage(loadingId, response);
            } catch (err) {
                console.error("Error capturado en sendChatMessage:", err);
                updateMessage(loadingId, "❌ Error de Conexión AI: " + err.message);
            }
        };

        function addMessage(text, side, id = null) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${side}`;
            if (id) div.id = id;
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function updateMessage(id, newText) {
            const el = document.getElementById(id);
            if (el) el.innerText = newText;
        }

        window.diagnoseAI = async function () {
            const apiKey = hrSettings.geminiApiKey;
            if (!apiKey) {
                addMessage("❌ No hay API Key configurada en Ajustes.", "bot");
                return;
            }
            addMessage("🔍 Diagnosticando conexión...", "bot");
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                const res = await fetch(url);
                const data = await res.json();
                if (res.ok) {
                    const models = data.models.map(m => m.name.split('/').pop());
                    addMessage("✅ Conexión Exitosa. Modelos disponibles: " + models.join(", "), "bot");
                } else {
                    addMessage("❌ Error de Google: " + (data.error?.message || "Desconocido"), "bot");
                }
            } catch (e) {
                addMessage("❌ Error de Red: " + e.message, "bot");
            }
        };

        async function getSmartResponse(query) {
            const apiKey = hrSettings.geminiApiKey;
            if (!apiKey) return "¡Hola! Configura tu API Key en Ajustes.";

            const models = ["gemini-1.5-flash", "gemini-flash-latest", "gemini-1.5-pro", "gemini-pro-latest"];
            let lastError = "";

            // --- PREPARACIÓN DE DATOS TOTALES (Modo Omnisciente) ---

            // 1. Directorio Completo
            const directorioCompleto = employees.map(e => ({
                n: e.nombre,
                c: e.clave,
                d: e.departamento,
                p: e.puesto || 'N/A',
                ing: e.fechaAntiguedad || e.fechaAlta || 'N/A',
                t: e.tipo || 'N/A'
            }));

            // 2. Histórico de Bajas
            const listaBajas = bajas.map(b => ({
                n: b.nombre,
                d: b.departamento,
                fb: b.fechaBaja || 'N/A'
            }));

            // 3. Resumen de Asistencia Integrado
            // Obtenemos un resumen de los últimos 60 días para no saturar pero dar buen detalle
            const fechasAsistencia = Object.keys(attendanceRecord).sort().slice(-60);
            const mapaAsistenciaLocal = {};

            fechasAsistencia.forEach(fecha => {
                Object.entries(attendanceRecord[fecha]).forEach(([clave, status]) => {
                    if (!mapaAsistenciaLocal[clave]) mapaAsistenciaLocal[clave] = [];
                    mapaAsistenciaLocal[clave].push({ f: fecha, s: status });
                });
            });

            // 4. Anomalías Graves
            const graves = window.scanForSeriousAnomalies ? window.scanForSeriousAnomalies() : [];

            const basePrompt = `Eres LulaBot, el cerebro AI de SIRECOA. TIENES ACCESO TOTAL A LOS DATOS.

            DIRECTORIO (${employees.length} colaboradores):
            ${JSON.stringify(directorioCompleto)}

            HISTÓRICO DE BAJAS:
            ${JSON.stringify(listaBajas)}

            HISTORIAL DE ASISTENCIA (Últimos 60 días):
            ${JSON.stringify(mapaAsistenciaLocal)}
            (Códigos: falta=Falta, asistencia=Presente, retardo=Retardo, permiso=Permiso, omision_e=Omisión Entrada, omision_s=Omisión Salida, vacaciones=Vacaciones)

            ALERTAS DE ANOMALÍAS GRAVES:
            ${JSON.stringify(graves)}

            REGLAS:
            1. Tienes TODO el historial. Si te preguntan por la asistencia de alguien, busca su Clave (c) o Nombre (n) en el HISTORIAL DE ASISTENCIA.
            2. Si un empleado no tiene registros en el historial, menciónalo como "sin incidencias registradas en los últimos 60 días".
            3. Responde de forma amable, profesional y usa emojis.
            4. Sé muy preciso con las fechas.

            PREGUNTA: "${query}"`;

            for (const modelName of models) {
                try {
                    // Usamos v1beta que fue la que te funcionó en el diagnóstico
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: basePrompt }] }]
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.candidates && data.candidates[0]) {
                        return data.candidates[0].content.parts[0].text;
                    }

                    lastError = data.error?.message || "Error desconocido";
                    console.warn(`Intento fallido con ${modelName}: ${lastError}`);

                    // Si es error de cuota o no encontrado, seguimos al siguiente
                    continue;
                } catch (e) {
                    lastError = e.message;
                    console.error(`Error de red con ${modelName}:`, e);
                }
            }

            throw new Error(`Agoté los modelos disponibles. El último error fue: ${lastError}. Prueba revisando tu cuota en Google AI Studio.`);
        }

        function getBotResponse(query) {
            const cleanQuery = query.toLowerCase().trim();

            // personnel count
            if (cleanQuery.includes('cuántos empleados') || cleanQuery.includes('total de empleados')) {
                return `📊 Registro Maestro: Actualmente cuento con **${employees.length}** colaboradores activos en la plataforma.`;
            }

            // ANALYSIS: Most punctual department
            if (cleanQuery.includes('puntualidad') || cleanQuery.includes('más puntual') || cleanQuery.includes('mejor asistencia')) {
                const deptStats = {};
                Object.values(attendanceRecord).forEach(date => {
                    Object.entries(date).forEach(([clave, status]) => {
                        const emp = employees.find(e => e.clave === clave);
                        if (emp && emp.departamento) {
                            if (!deptStats[emp.departamento]) deptStats[emp.departamento] = { total: 0, punctual: 0 };
                            deptStats[emp.departamento].total++;
                            if (status === 'laboral') deptStats[emp.departamento].punctual++;
                        }
                    });
                });
                const sorted = Object.entries(deptStats).sort((a, b) => (b[1].punctual / b[1].total) - (a[1].punctual / a[1].total));
                if (sorted.length === 0) return "No tengo suficientes registros de asistencia para determinar la puntualidad por área.";
                const best = sorted[0];
                const pct = Math.round((best[1].punctual / best[1].total) * 100);
                return `✨ **LulaBot Insights:** El área de **${best[0]}** destaca como la más puntual con un índice de efectividad del **${pct}%**.`;
            }

            // ANALYSIS: Absences / Anomalies
            if (cleanQuery.includes('faltas') || cleanQuery.includes('inasistencias') || cleanQuery.includes('anomalías')) {
                const results = window.scanForSeriousAnomalies();
                if (results.length === 0) return "✅ Diagnóstico: No he detectado patrones críticos de inasistencias en los últimos registros.";
                let resp = `⚠️ **Reporte de Anomalías:** He detectado a ${results.length} personas con patrones inconstantes:\n`;
                results.slice(0, 3).forEach(r => resp += `- **${r.nombre}**: ${r.count} incidencias.\n`);
                return resp;
            }

            // most seniority
            if (cleanQuery.includes('más antigüedad') || cleanQuery.includes('más antiguo')) {
                if (!employees || employees.length === 0) return "Aún no hay empleados registrados.";
                const sorted = [...employees].filter(e => e.fechaAntiguedad).sort((a, b) => window.parseDate(a.fechaAntiguedad) - window.parseDate(b.fechaAntiguedad));
                if (sorted.length === 0) return "No tengo fechas de antigüedad registradas.";
                const oldest = sorted[0];
                return `🥇 **Trayectoria Institucional:** El colaborador con mayor tiempo es **${oldest.nombre}**, con una antigüedad de: ${window.calculateDiff(oldest.fechaAntiguedad)}.`;
            }

            // specific employee search or seniority
            if (cleanQuery.includes('antigüedad de') || cleanQuery.includes('quién es') || cleanQuery.includes('información de') || cleanQuery.includes('buscar a')) {
                const namePart = cleanQuery.split(/de|es|a/).pop().trim();
                const emp = employees.find(e => e.nombre.toLowerCase().includes(namePart) || e.clave.toLowerCase().includes(namePart));
                if (emp) {
                    let info = `👤 **${emp.nombre}** (ID: ${emp.clave})\n`;
                    info += `- Área: ${emp.departamento}\n`;
                    info += `- Puesto: ${emp.tipo}\n`;
                    if (emp.fechaAntiguedad) info += `- Antigüedad: ${window.calculateDiff(emp.fechaAntiguedad)}\n`;
                    return info;
                }
                return `🔍 No encontré a "${namePart}" en mis registros actuales. Verifique que el nombre esté escrito correcamente.`;
            }

            // Help
            if (cleanQuery.includes('ayuda') || cleanQuery.includes('qué haces') || cleanQuery.includes('funciona')) {
                return "Soy LulaBot, tu analista de RH. Puedo buscar empleados, calcular antigüedades exactas, analizar puntualidad por departamento e identificar anomalías de asistencia.";
            }

            return "Entiendo. Intenta preguntarme por la 'antigüedad de [nombre]' o sobre el 'área más puntual'.";
        }
    </script>

    <style>
        .status-select {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 0.85rem;
            outline: none;
            cursor: pointer;
            transition: var(--transition);
            min-width: 180px;
        }

        .status-select:hover {
            border-color: var(--primary);
        }

        .status-indicator {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-indicator.pending {
            background: #e2e8f0;
            color: #94a3b8;
        }

        [data-theme="dark"] .status-indicator.pending {
            background: #334155;
            color: #64748b;
        }
    </style>


    <!-- ChatBot HTML -->
    <div id="chatbot-toggle" class="chatbot-toggle" onclick="window.toggleChat()" title="Hablar con LulaBot"
        style="background: #00aeef; box-shadow: 0 10px 25px rgba(0, 174, 239, 0.4);">
        <svg viewBox="0 0 100 100" width="45" height="45">
            <!-- Robot Head -->
            <rect x="25" y="20" width="50" height="42" rx="15" fill="white" />
            <!-- Face Screen -->
            <rect x="32" y="28" width="36" height="24" rx="8" fill="#1e293b" />
            <!-- Eyes -->
            <circle cx="42" cy="38" r="3" fill="#22d3ee">
                <animate attributeName="opacity" values="1;0.4;1" dur="3s" repeatCount="indefinite" />
            </circle>
            <circle cx="58" cy="38" r="3" fill="#22d3ee">
                <animate attributeName="opacity" values="1;0.4;1" dur="3s" repeatCount="indefinite" />
            </circle>
            <!-- Smile -->
            <path d="M44 46 Q50 50 56 46" stroke="#22d3ee" stroke-width="2.5" fill="none" stroke-linecap="round" />
            <!-- Antennas -->
            <line x1="25" y1="41" x2="16" y2="41" stroke="white" stroke-width="3" stroke-linecap="round" />
            <circle cx="16" cy="41" r="4" fill="white" />
            <line x1="75" y1="41" x2="84" y2="41" stroke="white" stroke-width="3" stroke-linecap="round" />
            <circle cx="84" cy="41" r="4" fill="white" />
            <!-- Body & Laptop simplified for icon -->
            <path d="M35 62 Q50 58 65 62 L60 85 L40 85 Z" fill="rgba(255,255,255,0.8)" />
        </svg>
    </div>

    <div id="chat-window" class="chat-window">
        <div class="chat-header" style="background: #00aeef;">
            <div style="display: flex; align-items: center; gap: 0.8rem;">
                <div
                    style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <svg viewBox="0 0 100 100" width="32" height="32">
                        <rect x="25" y="20" width="50" height="42" rx="15" fill="#00aeef" />
                        <rect x="32" y="28" width="36" height="24" rx="8" fill="#1e293b" />
                        <circle cx="42" cy="38" r="3" fill="#22d3ee" />
                        <circle cx="58" cy="38" r="3" fill="#22d3ee" />
                        <path d="M44 46 Q50 50 56 46" stroke="#22d3ee" stroke-width="2.5" fill="none"
                            stroke-linecap="round" />
                        <circle cx="16" cy="41" r="4" fill="#00aeef" />
                        <circle cx="84" cy="41" r="4" fill="#00aeef" />
                    </svg>
                </div>
                <div>
                    <div style="font-weight: 700; font-size: 0.95rem; letter-spacing: 0.3px;">LulaBot <span
                            style="font-size: 0.6rem; color: #b59b6b; font-weight: normal; margin-left: 5px;">v2.1</span>
                    </div>
                    <div style="font-size: 0.72rem; opacity: 0.9; font-weight: 400;">Analista de Capital Humano</div>
                </div>
            </div>
            <button onclick="window.toggleChat()"
                style="background:transparent; border:none; color:white; cursor:pointer;">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div id="chat-messages" class="chat-messages">
            <div class="message bot">¡Hola! Soy LulaBot. Puedo ayudarte con información del personal, asistencias,
                antigüedad o reglas del sistema. ¿En qué puedo apoyarte hoy?</div>
            <div style="text-align: center; margin: 10px 0;">
                <button onclick="window.diagnoseAI()"
                    style="background: rgba(0,0,0,0.05); border: 1px dashed var(--border); padding: 5px 10px; border-radius: 20px; font-size: 0.7rem; color: var(--text-muted); cursor: pointer;">🔍
                    Verificar Conexión AI</button>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Escribe tu pregunta..."
                onkeypress="if(event.key === 'Enter') window.sendChatMessage()">
            <button class="btn btn-primary" style="padding: 0.6rem;" onclick="window.sendChatMessage()">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

</body>

</html>